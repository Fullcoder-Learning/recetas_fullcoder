<!DOCTYPE html>
<html  lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

      <title>API Task Learn</title>
    
          <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
          <link rel="stylesheet" href="../_static/theme.css " type="text/css" />
      
      <!-- sphinx script_files -->
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/translations.js"></script>

      
      <!-- bundled in js (rollup iife) -->
      <!-- <script src="../_static/theme-vendors.js"></script> -->
      <script src="../_static/theme.js" defer></script>
    
      <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <link rel="index" title="Índice" href="../genindex.html" />
  <link rel="search" title="Búsqueda" href="../search.html" />
  <link rel="next" title="Frontend React Task Learn" href="../frontend/react.html" />
  <link rel="prev" title="Recetas Fullcoder - Agile Learning Practico" href="../index.html" /> 
  </head>

  <body>
    <div id="app">
    <div class="theme-container" :class="pageClasses"><navbar @toggle-sidebar="toggleSidebar">
  <router-link to="../index.html" class="home-link">
    
      <img class="logo" src="../_static/fullcoderlogo.png" alt="logo"/>
    
  </router-link>

  <div class="links">
    <navlinks class="can-hide">

  
    <div class="nav-item">
      <a href="../index.html#recetas-fullcoder-agile-learning-practico"
         class="nav-link  router-link-active">
         Proyectos Backend
      </a>
    </div>
  
    <div class="nav-item">
      <a href="../index.html#recetas-fullcoder-agile-learning-practico"
         class="nav-link ">
         Proyectos Frontend
      </a>
    </div>
  



    </navlinks>
  </div>
</navbar>

      
      <div class="sidebar-mask" @click="toggleSidebar(false)">
      </div>
        <sidebar @toggle-sidebar="toggleSidebar">
          
          <navlinks>
            

  
    <div class="nav-item">
      <a href="../index.html#recetas-fullcoder-agile-learning-practico"
         class="nav-link  router-link-active">
         Proyectos Backend
      </a>
    </div>
  
    <div class="nav-item">
      <a href="../index.html#recetas-fullcoder-agile-learning-practico"
         class="nav-link ">
         Proyectos Frontend
      </a>
    </div>
  



            
          </navlinks><div id="searchbox" class="searchbox" role="search">
  <div class="caption"><span class="caption-text">Búsqueda rápida</span>
    <div class="searchformwrapper">
      <form class="search" action="../search.html" method="get">
        <input type="text" name="q" />
        <input type="submit" value="Búsqueda" />
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div><div class="sidebar-links" role="navigation" aria-label="main navigation">
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="../index.html#recetas-fullcoder-agile-learning-practico">Proyectos Backend</a></span>
      </p>
      <ul class="current">
        
          <li class="toctree-l1 current">
            
              <a href="#" class="reference internal current">API Task Learn</a>
            

            
              <ul>
                
                  <li class="toctree-l2"><a href="#fase-1-sistema-de-tareas" class="reference internal">Fase 1: Sistema de Tareas</a></li>
                
                  <li class="toctree-l2"><a href="#fase-2-usuarios-y-securizacion" class="reference internal">Fase 2: Usuarios y securización</a></li>
                
                  <li class="toctree-l2"><a href="#fase-3-recuperacion-de-contrasenas" class="reference internal">Fase 3: Recuperación de contraseñas</a></li>
                
                  <li class="toctree-l2"><a href="#fase-4-manejo-de-archivos" class="reference internal">Fase 4: Manejo de archivos</a></li>
                
              </ul>
            
          </li>

        
      </ul>
    </div>
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="../index.html#recetas-fullcoder-agile-learning-practico">Proyectos Frontend</a></span>
      </p>
      <ul class="">
        
          <li class="toctree-l1 ">
            
              <a href="../frontend/react.html" class="reference internal ">Frontend React Task Learn</a>
            

            
          </li>

        
      </ul>
    </div>
  
</div>
        </sidebar>

      <page>
          <div class="body-header" role="navigation" aria-label="navigation">
  
  <ul class="breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
    
    <li>API Task Learn</li>
  </ul>
  

  <ul class="page-nav">
  <li class="prev">
    <a href="../index.html"
       title="capítulo anterior">← Recetas Fullcoder - Agile Learning Practico</a>
  </li>
  <li class="next">
    <a href="../frontend/react.html"
       title="próximo capítulo">Frontend React Task Learn →</a>
  </li>
</ul>
  
</div>
<hr>
          <div class="content" role="main" v-pre>
            
  <section id="api-task-learn">
<h1><a class="toc-backref" href="#id3">API Task Learn</a><a class="headerlink" href="#api-task-learn" title="Enlazar permanentemente con este título">¶</a></h1>
<a class="reference internal image-reference" href="../_images/logo-node-express-mongo.png"><img alt="Logo NodeJS" class="align-center" src="../_images/logo-node-express-mongo.png" style="width: 750.0px; height: 240.0px;" /></a>
<p>Servicio API Rest para listado de tareas creada con Nodejs + Express + MongoDB</p>
<ul class="simple">
<li><p>Repositorio proyecto completo: <a class="reference external" href="https://github.com/Fullcoder-Learning/task-learning-api/tree/master">https://github.com/Fullcoder-Learning/task-learning-api/tree/master</a></p></li>
<li><p>Collección Postman: <a class="reference external" href="https://drive.google.com/file/d/14F3SxSIUBy0eh4fpJbvY3WWt0WIL18zq/view?usp=sharing">https://drive.google.com/file/d/14F3SxSIUBy0eh4fpJbvY3WWt0WIL18zq/view?usp=sharing</a></p></li>
<li><p>Variables de entorno Postman: <a class="reference external" href="https://drive.google.com/file/d/1yFmZUS1Pb5yYy4W8ju5dAEGh6BGoSnNH/view?usp=sharing">https://drive.google.com/file/d/1yFmZUS1Pb5yYy4W8ju5dAEGh6BGoSnNH/view?usp=sharing</a></p></li>
</ul>
<div class="contents topic" id="indice">
<p class="topic-title">Índice</p>
<ul class="simple">
<li><p><a class="reference internal" href="#api-task-learn" id="id3">API Task Learn</a></p>
<ul>
<li><p><a class="reference internal" href="#fase-1-sistema-de-tareas" id="id4">Fase 1: Sistema de Tareas</a></p>
<ul>
<li><p><a class="reference internal" href="#paso-1-instalaciones" id="id5">Paso 1: Instalaciones</a></p>
<ul>
<li><p><a class="reference internal" href="#en-windows" id="id6">En Windows</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#paso-2-preparar-proyecto" id="id7">Paso 2: Preparar proyecto</a></p></li>
<li><p><a class="reference internal" href="#paso-3-archivo-de-rutas-y-dependencias" id="id8">Paso 3: Archivo de rutas y dependencias</a></p></li>
<li><p><a class="reference internal" href="#paso-4-archivo-de-entrada" id="id9">Paso 4: Archivo de entrada</a></p></li>
<li><p><a class="reference internal" href="#paso-5-opcional-ejecutar-servidor-en-modo-depuracion" id="id10">Paso 5 (opcional): Ejecutar servidor en modo depuración</a></p></li>
<li><p><a class="reference internal" href="#paso-6-crear-controlador" id="id11">Paso 6: Crear controlador</a></p></li>
<li><p><a class="reference internal" href="#paso-7-crear-ruta-a-controlador" id="id12">Paso 7: Crear ruta a controlador</a></p></li>
<li><p><a class="reference internal" href="#paso-8-opcional-crear-coleccion-postman" id="id13">Paso 8 (opcional): Crear colección Postman</a></p></li>
<li><p><a class="reference internal" href="#paso-9-cargar-punto-de-ruta" id="id14">Paso 9: Cargar punto de ruta</a></p></li>
<li><p><a class="reference internal" href="#paso-10-conectar-a-base-de-datos-mongodb" id="id15">Paso 10: Conectar a base de datos MongoDB</a></p></li>
<li><p><a class="reference internal" href="#paso-11-crear-modelo-de-datos" id="id16">Paso 11: Crear modelo de datos</a></p></li>
<li><p><a class="reference internal" href="#paso-12-crear-tareas-controller" id="id17">Paso 12: Crear tareas (controller)</a></p></li>
<li><p><a class="reference internal" href="#paso-13-crear-tareas-routes" id="id18">Paso 13: Crear tareas (routes)</a></p></li>
<li><p><a class="reference internal" href="#paso-14-opcional-comprobar-datos-en-studio3t" id="id19">Paso 14 (Opcional): Comprobar datos en Studio3T</a></p></li>
<li><p><a class="reference internal" href="#paso-15-listar-tareas-controller" id="id20">Paso 15: Listar tareas (controller)</a></p></li>
<li><p><a class="reference internal" href="#paso-16-mostrar-una-tarea-controller" id="id21">Paso 16: Mostrar una tarea (controller)</a></p></li>
<li><p><a class="reference internal" href="#paso-17-mostrar-una-tarea-router" id="id22">Paso 17: Mostrar una tarea (router)</a></p></li>
<li><p><a class="reference internal" href="#paso-18-actualizar-datos-de-una-tarea-controller" id="id23">Paso 18: Actualizar datos de una tarea (controller)</a></p></li>
<li><p><a class="reference internal" href="#paso-19-actualizar-datos-de-una-tarea-router" id="id24">Paso 19: Actualizar datos de una tarea (router)</a></p></li>
<li><p><a class="reference internal" href="#paso-18-eliminar-una-tarea-controller" id="id25">Paso 18: Eliminar una tarea (controller)</a></p></li>
<li><p><a class="reference internal" href="#paso-19-eliminar-una-tarea-router" id="id26">Paso 19: Eliminar una tarea (router)</a></p></li>
<li><p><a class="reference internal" href="#paso-20-cambiar-estado-de-tarea-controller" id="id27">Paso 20: Cambiar estado de tarea (controller)</a></p></li>
<li><p><a class="reference internal" href="#paso-21-cambiar-estado-de-tarea-router" id="id28">Paso 21: Cambiar estado de tarea (router)</a></p></li>
<li><p><a class="reference internal" href="#paso-22-subir-cambios-a-github" id="id29">Paso 22: Subir cambios a GitHub</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#fase-2-usuarios-y-securizacion" id="id30">Fase 2: Usuarios y securización</a></p>
<ul>
<li><p><a class="reference internal" href="#paso-1-preparar-proyecto" id="id31">Paso 1: Preparar proyecto</a></p></li>
<li><p><a class="reference internal" href="#paso-2-crear-modelo-de-usuarios" id="id32">Paso 2: Crear modelo de usuarios</a></p></li>
<li><p><a class="reference internal" href="#paso-3-registro-de-usuarios-controller" id="id33">Paso 3: Registro de usuarios (controller)</a></p></li>
<li><p><a class="reference internal" href="#paso-4-registro-de-usuarios-router" id="id34">Paso 4: Registro de usuarios (router)</a></p></li>
<li><p><a class="reference internal" href="#paso-5-registrar-rutas-de-usuarios" id="id35">Paso 5: Registrar rutas de usuarios</a></p></li>
<li><p><a class="reference internal" href="#paso-6-crear-variables-de-entorno" id="id36">Paso 6: Crear variables de entorno</a></p></li>
<li><p><a class="reference internal" href="#paso-7-crear-servicio-jwt" id="id37">Paso 7: Crear servicio JWT</a></p></li>
<li><p><a class="reference internal" href="#paso-8-crear-login-controller" id="id38">Paso 8: Crear login (controller)</a></p></li>
<li><p><a class="reference internal" href="#paso-9-crear-login-router" id="id39">Paso 9: Crear login (router)</a></p></li>
<li><p><a class="reference internal" href="#paso-10-crear-middleware-para-securizar-rutas" id="id40">Paso 10: Crear middleware para securizar rutas</a></p></li>
<li><p><a class="reference internal" href="#paso-11-proteger-endpoints-de-tareas" id="id41">Paso 11: Proteger endpoints de tareas</a></p></li>
<li><p><a class="reference internal" href="#paso-12-relacionar-tareas-con-usuarios" id="id42">Paso 12: Relacionar tareas con usuarios</a></p></li>
<li><p><a class="reference internal" href="#paso-13-crear-middleware-para-recuperar-usuario" id="id43">Paso 13: Crear middleware para recuperar usuario</a></p></li>
<li><p><a class="reference internal" href="#paso-14-modificar-modulos-de-controlador-task" id="id44">Paso 14: Modificar modulos de controlador task</a></p></li>
<li><p><a class="reference internal" href="#paso-15-subir-cambios-a-github" id="id45">Paso 15: Subir cambios a GitHub</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#fase-3-recuperacion-de-contrasenas" id="id46">Fase 3: Recuperación de contraseñas</a></p>
<ul>
<li><p><a class="reference internal" href="#id1" id="id47">Paso 2: Preparar proyecto</a></p></li>
<li><p><a class="reference internal" href="#paso-3-enviar-email-controller" id="id48">Paso 3: Enviar email (controller)</a></p></li>
<li><p><a class="reference internal" href="#paso-4-enviar-email-router" id="id49">Paso 4: Enviar email (router)</a></p></li>
<li><p><a class="reference internal" href="#paso-5-reestablecer-contrasena-controller" id="id50">Paso 5: Reestablecer contraseña (controller)</a></p></li>
<li><p><a class="reference internal" href="#paso-6-reestablecer-contrasena-router" id="id51">Paso 6: Reestablecer contraseña (router)</a></p></li>
<li><p><a class="reference internal" href="#paso-7-subir-cambios-a-github" id="id52">Paso 7: Subir cambios a GitHub</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#fase-4-manejo-de-archivos" id="id53">Fase 4: Manejo de archivos</a></p>
<ul>
<li><p><a class="reference internal" href="#id2" id="id54">Paso 1: Preparar proyecto</a></p></li>
<li><p><a class="reference internal" href="#paso-2-editar-modelo-usuarios" id="id55">Paso 2: Editar modelo usuarios</a></p></li>
<li><p><a class="reference internal" href="#paso-3-recuperar-usuario-y-actualizar-imagen-de-usuario-controller" id="id56">Paso 3: Recuperar usuario y actualizar imagen de usuario (controller)</a></p></li>
<li><p><a class="reference internal" href="#paso-4-recuperar-usuario-y-actualizar-imagen-de-usuario-router" id="id57">Paso 4: Recuperar usuario y actualizar imagen de usuario (router)</a></p></li>
<li><p><a class="reference internal" href="#paso-5-recuperar-avatar-controller" id="id58">paso 5: Recuperar avatar (controller)</a></p></li>
<li><p><a class="reference internal" href="#paso-6-recuperar-avatar-router" id="id59">paso 6: Recuperar avatar (router)</a></p></li>
<li><p><a class="reference internal" href="#paso-7-eliminar-usuario-controller" id="id60">Paso 7: Eliminar usuario (controller)</a></p></li>
<li><p><a class="reference internal" href="#paso-8-eliminar-usuario-router" id="id61">Paso 8: Eliminar usuario (router)</a></p></li>
<li><p><a class="reference internal" href="#paso-9-subir-cambios-a-github" id="id62">Paso 9: Subir cambios a GitHub</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<section id="fase-1-sistema-de-tareas">
<h2><a class="toc-backref" href="#id4">Fase 1: Sistema de Tareas</a><a class="headerlink" href="#fase-1-sistema-de-tareas" title="Enlazar permanentemente con este título">¶</a></h2>
<p>En esta fase se va a crear la base del proyecto y todo el CRUD de tareas.</p>
<section id="paso-1-instalaciones">
<h3><a class="toc-backref" href="#id5">Paso 1: Instalaciones</a><a class="headerlink" href="#paso-1-instalaciones" title="Enlazar permanentemente con este título">¶</a></h3>
<section id="en-windows">
<h4><a class="toc-backref" href="#id6">En Windows</a><a class="headerlink" href="#en-windows" title="Enlazar permanentemente con este título">¶</a></h4>
<ul class="simple">
<li><p>Instalar NodeJS desde su sitio oficial: <a class="reference external" href="https://nodejs.org/es/">https://nodejs.org/es/</a></p></li>
<li><p>Instalar MongoDB desde su sitio oficial:  <a class="reference external" href="https://www.mongodb.com/try/download/community">https://www.mongodb.com/try/download/community</a></p></li>
<li><p>(Interesante) Instalar Visual Studio Code desde su sitio oficial: <a class="reference external" href="https://code.visualstudio.com/download">https://code.visualstudio.com/download</a></p></li>
<li><p>(Interesante) Instalar Postman desde su sitio oficial: <a class="reference external" href="https://www.postman.com/downloads/">https://www.postman.com/downloads/</a></p></li>
<li><p>(Interesante) Instalar Robo3T o Studio3T desde su sitio oficial: <a class="reference external" href="https://robomongo.org/">https://robomongo.org/</a></p></li>
</ul>
<div class="admonition attention">
<p class="admonition-title">Atención</p>
<p>Studio 3T Free tiene una capa gratuita, pese a que comience con un periodo de prueba. Luego es totalmente funcional limitando algunas características de pago.</p>
</div>
</section>
</section>
<section id="paso-2-preparar-proyecto">
<h3><a class="toc-backref" href="#id7">Paso 2: Preparar proyecto</a><a class="headerlink" href="#paso-2-preparar-proyecto" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Crear una carpeta para el proyecto con el nombre por ejemplo: <strong>task-learn-api</strong>.</p></li>
<li><p>Crear un repositorio en github, gitlab o simil.</p></li>
<li><p>ejecutar <code class="docutils literal notranslate"><span class="pre">npm</span> <span class="pre">init</span></code> para iniciar el proyecto.</p></li>
<li><p>instalar express: <code class="docutils literal notranslate"><span class="pre">npm</span> <span class="pre">install</span> <span class="pre">express</span> <span class="pre">--save</span></code></p></li>
<li><p>instalar mongoose: <code class="docutils literal notranslate"><span class="pre">npm</span> <span class="pre">install</span> <span class="pre">mongoose</span> <span class="pre">--save</span></code></p></li>
<li><p>instalar nodemon: <code class="docutils literal notranslate"><span class="pre">npm</span> <span class="pre">install</span> <span class="pre">nodemon</span> <span class="pre">--save-dev</span></code></p></li>
<li><p>Instalar cors: <code class="docutils literal notranslate"><span class="pre">npm</span> <span class="pre">install</span> <span class="pre">cors</span> <span class="pre">--save</span></code></p></li>
<li><p>crear archivos <strong>index.js</strong> y <strong>app.js</strong></p></li>
<li><p>crear carpetas <strong>controllers</strong>, <strong>routes</strong>, y <strong>models</strong></p></li>
<li><p>Crear archivo <strong>.gitignore</strong> y añadir la siguiente línea:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">node_modules</span><span class="o">/</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Añadir el comando <strong>start</strong> en el índice <strong>scripts</strong> de <strong>packages.json</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;scripts&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;test&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;start&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;node index.js&quot;</span><span class="w"> </span><span class="c1">// añadir esta línea para poder ejecutar servidor con npm start</span><span class="w"></span>
<span class="p">},</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>Inicializar repositorio: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">init</span></code></p></li>
<li><p>Añadir repositorio remoto: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">remote</span> <span class="pre">add</span> <span class="pre">origin</span> <span class="pre">https://github.com/Fullcoder-Learning/task-learning-api.git</span></code></p></li>
<li><p>Añadir cambios: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">add</span> <span class="pre">.</span></code></p></li>
<li><p>Hacer primer commit: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">commit</span> <span class="pre">-am</span> <span class="pre">&quot;first</span> <span class="pre">commit&quot;</span></code></p></li>
<li><p>Subir cambios a repositorio remoto: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">push</span> <span class="pre">origin</span> <span class="pre">master</span></code></p></li>
<li><p>Crear rama desarrollo: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">checkout</span> <span class="pre">-b</span> <span class="pre">developer</span></code></p></li>
<li><p>Subir rama desarrollo: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">push</span> <span class="pre">origin</span> <span class="pre">developer</span></code></p></li>
<li><p>Crear rama feature a partir de developer: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">checkout</span> <span class="pre">-b</span> <span class="pre">feature/phase-1-task-system</span></code></p></li>
</ul>
<div class="admonition attention">
<p class="admonition-title">Atención</p>
<p>En el repositorio no se mostrarán las carpetas vacías ya que Git no las sube si no tienen nada. Para ello hay que añadir un archivo llamado <strong>.gitkeep</strong>
en cada carpeta vacía. No lo haremos en estos casos ya que no van a estarlo en breve.</p>
</div>
</section>
<section id="paso-3-archivo-de-rutas-y-dependencias">
<h3><a class="toc-backref" href="#id8">Paso 3: Archivo de rutas y dependencias</a><a class="headerlink" href="#paso-3-archivo-de-rutas-y-dependencias" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Editar <strong>app.js</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// importar e inicializar express:</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;express&quot;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">();</span><span class="w"></span>

<span class="c1">// importar cors:</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">cors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cors&#39;</span><span class="p">);</span><span class="w"></span>
<span class="c1">// habilitar todas las peticiones cors:</span><span class="w"></span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cors</span><span class="p">());</span><span class="w"></span>
<span class="c1">// para trabajar con json se carga el modulo json de express:</span><span class="w"></span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span><span class="w"></span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">urlencoded</span><span class="p">({</span><span class="nx">extended</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">}));</span><span class="w"> </span><span class="c1">// también es necesaria la codificación</span><span class="w"></span>


<span class="c1">// exportar app para index.js:</span><span class="w"></span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">app</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="paso-4-archivo-de-entrada">
<h3><a class="toc-backref" href="#id9">Paso 4: Archivo de entrada</a><a class="headerlink" href="#paso-4-archivo-de-entrada" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Editar <strong>index.js</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// importa la constante app con express:</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./app&#39;</span><span class="p">);</span><span class="w"></span>
<span class="c1">// cargar el puerto en una variable:</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5000</span><span class="p">;</span><span class="w"></span>

<span class="c1">// lanzar el escuchador con un mensaje para saber que funciona:</span><span class="w"></span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Servidor funcionando en: http://localhost:</span><span class="si">${</span><span class="nx">port</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span><span class="w"></span>
<span class="p">});</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>Ejecutar <code class="docutils literal notranslate"><span class="pre">npm</span> <span class="pre">start</span></code> y comprobar que muestra el mensaje de que se está ejecutando.</p></li>
</ul>
</section>
<section id="paso-5-opcional-ejecutar-servidor-en-modo-depuracion">
<h3><a class="toc-backref" href="#id10">Paso 5 (opcional): Ejecutar servidor en modo depuración</a><a class="headerlink" href="#paso-5-opcional-ejecutar-servidor-en-modo-depuracion" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Si estás usando <strong>Visual Studio Code</strong> presiona el botón con el icono que tiene un símbolo de <strong>play</strong> y un <strong>bicho</strong>:
- Haz clic en el texto <strong>cree un archivo launch.json</strong> y selecciona la opción <strong>node.js</strong>.
- Modificar el archivo que se muestra para que trabaje con <strong>nodemon</strong> y pueda hacer fastReload:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Use IntelliSense para saber los atributos posibles.</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Mantenga el puntero para ver las descripciones de los existentes atributos.</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Para más información, visite: https://go.microsoft.com/fwlink/?linkid=830387</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;version&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0.2.0&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;configurations&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="s2">&quot;type&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;pwa-node&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="s2">&quot;request&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;launch&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Launch Program&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="s2">&quot;skipFiles&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">                </span><span class="s2">&quot;&lt;node_internals&gt;/**&quot;</span><span class="w"></span>
<span class="w">            </span><span class="p">],</span><span class="w"></span>
<span class="w">            </span><span class="c1">// reemplazar la linea program por la ruta de nodemon y añadir la ruta de index.js en args:</span><span class="w"></span>
<span class="w">            </span><span class="s2">&quot;program&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;${workspaceFolder}/node_modules/nodemon/bin/nodemon.js&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="s2">&quot;args&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">                </span><span class="s2">&quot;${workspaceFolder}\\index.js&quot;</span><span class="w"></span>
<span class="w">            </span><span class="p">]</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>Arriba a la izquierda presiona el botón verde con símbolo <strong>play</strong> junto al texto <strong>Launch Program</strong> para ejecutar servidor en modo depuración.</p></li>
</ul>
<p>De este modo podremos depurar punto a punto la aplicación.</p>
</section>
<section id="paso-6-crear-controlador">
<h3><a class="toc-backref" href="#id11">Paso 6: Crear controlador</a><a class="headerlink" href="#paso-6-crear-controlador" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Crear un archivo llamado <strong>taskController.js</strong> dentro de la carpeta <strong>controllers</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// se crea la función del controlador que recibe el request y la response:</span><span class="w"></span>
<span class="kd">function</span><span class="w"> </span><span class="nx">getTasks</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Task Controller it&#39;s OK&quot;</span><span class="p">});</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// exportar el módulo getTasks:</span><span class="w"></span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">getTasks</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="paso-7-crear-ruta-a-controlador">
<h3><a class="toc-backref" href="#id12">Paso 7: Crear ruta a controlador</a><a class="headerlink" href="#paso-7-crear-ruta-a-controlador" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Crear un archivo llamado <strong>taskRoutes.js</strong> dentro de la carpeta <strong>routes</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// se importa y carga el enrutador de express:</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">api</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span><span class="w"></span>

<span class="c1">// se importan los controladores para cada ruta:</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">taskController</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../controllers/taskController&quot;</span><span class="p">);</span><span class="w"></span>

<span class="c1">// se le pasa el controlador a la ruta:</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/tasks&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">taskController</span><span class="p">.</span><span class="nx">getTasks</span><span class="p">);</span><span class="w"></span>

<span class="c1">// se exporta el archivo de rutas:</span><span class="w"></span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">api</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="paso-8-opcional-crear-coleccion-postman">
<h3><a class="toc-backref" href="#id13">Paso 8 (opcional): Crear colección Postman</a><a class="headerlink" href="#paso-8-opcional-crear-coleccion-postman" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Ejecutar Postman y pulsar el botón <strong>+</strong> para crear nueva colección con el nombre <strong>Task learn API</strong>.</p></li>
<li><p>Arriba a la derecha justo después del texto <strong>No Envionment</strong> pinchar en el icono que muestra un cuadro con un ojo y luego en el texto <strong>Add</strong></p></li>
<li><p>De este modo se crea un Entorno o <strong>Envionment</strong> para añadir variables en Postman. Lo llamamos <strong>Task Learn Envionment</strong>.</p></li>
<li><p>En el campo <strong>VARIABLE</strong> añadimos el texto <strong>base_url</strong>.</p></li>
<li><p>En los campos <strong>INITIAL VALUE</strong> y <strong>CURRENT VALUE</strong> añadimos la url del proyecto: <a class="reference external" href="http://localhost:3000/api">http://localhost:3000/api</a></p></li>
<li><p>Pulsamos el botón <strong>Save</strong> y ya podemos cerrar esta pestaña.</p></li>
<li><p>A partir de ahora en lugar de introducir la url: <a class="reference external" href="http://localhost:3000/api/tasks">http://localhost:3000/api/tasks</a> introducimos <strong>{{url_base}}/tasks</strong></p></li>
</ul>
<div class="admonition attention">
<p class="admonition-title">Atención</p>
<p>Si presenta algún problema usando las variables de entorno. Comprueba que arriba a la derecha se encuentra el texto <strong>Task Learn Envionment</strong> en lugar de <strong>No Envionment</strong> u otro diferente.</p>
</div>
</section>
<section id="paso-9-cargar-punto-de-ruta">
<h3><a class="toc-backref" href="#id14">Paso 9: Cargar punto de ruta</a><a class="headerlink" href="#paso-9-cargar-punto-de-ruta" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Hay que cargar el archivo de rutas en un nuevo punto de ruta en <strong>app.js</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;express&quot;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">();</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">cors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cors&#39;</span><span class="p">);</span><span class="w"></span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cors</span><span class="p">());</span><span class="w"></span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span><span class="w"></span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">urlencoded</span><span class="p">({</span><span class="nx">extended</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">}));</span><span class="w"></span>


<span class="c1">// importar modulo de las task routes:</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">taskRoutes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/taskRoutes&#39;</span><span class="p">);</span><span class="w"></span>

<span class="c1">// crear punto de partida para las rutas de task:</span><span class="w"></span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&quot;/api&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">taskRoutes</span><span class="p">);</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">app</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>Añadir y comprobar en Postman que funciona la ruta tipo GET: <a class="reference external" href="http://localhost:3000/api/tasks">http://localhost:3000/api/tasks</a> o <strong>{{url_base}}/tasks</strong></p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Recuerda guardar las rutas pulsando el botón <strong>Save</strong>.</p>
</div>
</section>
<section id="paso-10-conectar-a-base-de-datos-mongodb">
<h3><a class="toc-backref" href="#id15">Paso 10: Conectar a base de datos MongoDB</a><a class="headerlink" href="#paso-10-conectar-a-base-de-datos-mongodb" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Editar el archivo <strong>index.js</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// importar el modulo mongoose:</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">mongoose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongoose&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./app&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5000</span><span class="p">;</span><span class="w"></span>

<span class="c1">// conectar mongoose a mongodb, en la ruta de la base de datos el /task-learn crear una nueva base de datos con dicho nombre:</span><span class="w"></span>
<span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/task-learn&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// trabajar con try / catch por si la url no estuviese bien definida:</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="nx">err</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// si todo va bien avisamos por consola:</span><span class="w"></span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Se ha extablecido la conexión a la base de datos&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">});</span><span class="w"></span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Servidor funcionando en: http://localhost:</span><span class="si">${</span><span class="nx">port</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span><span class="w"></span>
<span class="p">});</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>Al guardar el archivo, comprobamos en consola el mensaje: <strong>Se ha extablecido la conexión a la base de datos</strong></p></li>
</ul>
</section>
<section id="paso-11-crear-modelo-de-datos">
<h3><a class="toc-backref" href="#id16">Paso 11: Crear modelo de datos</a><a class="headerlink" href="#paso-11-crear-modelo-de-datos" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Crear un modelo de datos para las tareas en la carpeta <strong>models</strong> con el nombre <strong>taskModel.js</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// se importa mongoose para mongodb y se inicializa el modulo schema para hacer un modelo:</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">mongoose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongoose&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">Schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">;</span><span class="w"></span>

<span class="c1">// se crea un schema del modelo:</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">TaskSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Schema</span><span class="p">({</span><span class="w"> </span><span class="c1">// todos los campos van a ser requeridos (require: true)</span><span class="w"></span>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// se crea un título de tipo cadena</span><span class="w"></span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">require</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// del mismo modo se crea la descripción</span><span class="w"></span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">require</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="nx">is_complete</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// se crea un campo para verificar si se ha completado</span><span class="w"></span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">Boolean</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">require</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="c1">// por defecto se asignará el valor false</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="nx">date_created</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// se crea un campo para la fecha de creación</span><span class="w"></span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">require</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="w"> </span><span class="c1">// por defecto llevará la fecha de creación en el momento</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="nx">date_finish</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// este campo define la fecha de finalización</span><span class="w"></span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">require</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="c1">// por defecto irá en nulo.</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">});</span><span class="w"></span>

<span class="c1">// se exporta el modelo añadiendo el nombre de la colección de MongoDB y el Schema:</span><span class="w"></span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s2">&quot;tasks&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">TaskSchema</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition attention">
<p class="admonition-title">Atención</p>
<p>Cualquier nombre que pongas al modelo creará una colección e plural ej. task = tasks, gato = gatos.</p>
</div>
</section>
<section id="paso-12-crear-tareas-controller">
<h3><a class="toc-backref" href="#id17">Paso 12: Crear tareas (controller)</a><a class="headerlink" href="#paso-12-crear-tareas-controller" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Editamos el controlador <strong>taskController.js</strong> y añadimos una nueva función:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// cargar el modelo de tasks:</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">Task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/taskModel&#39;</span><span class="p">);</span><span class="w"></span>

<span class="c1">// nueva función asíncrona para crear tareas:</span><span class="w"></span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">postTask</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="c1">// se crea una objeto del modelo:</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Task</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="c1">// recuperar los parámetros del body:</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// recuperar los datos del body y añadirlos al modelo:</span><span class="w"></span>
<span class="w">    </span><span class="nx">task</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="nx">task</span><span class="p">.</span><span class="nx">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">description</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// guardar datos:</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// guardar resultados en la base de datos:</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">taskStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">task</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span><span class="w"> </span><span class="c1">// el proceso será lineal hasta llegar al await (evita ejecutar todo a la vez)</span><span class="w"></span>

<span class="w">        </span><span class="c1">// revisar si no se ha guardado la tarea:</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">taskStore</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: cannot create task&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">task</span><span class="o">:</span><span class="w"> </span><span class="nx">taskStore</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="c1">// devolver error 500 si sale mal:</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">function</span><span class="w"> </span><span class="nx">getTasks</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Task Controller it&#39;s OK&quot;</span><span class="p">});</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">postTask</span><span class="p">,</span><span class="w"> </span><span class="c1">// exportar modulo nuevo</span><span class="w"></span>
<span class="w">    </span><span class="nx">getTasks</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition attention">
<p class="admonition-title">Atención</p>
<p>Es importante controlar los parámetros que entran en nuestra aplicación. Por ello aquí solo necesitamos que se introduzcan los campos <strong>title</strong> y <strong>description</strong>. El resto ya son automáticos o funcionan con un update.</p>
</div>
</section>
<section id="paso-13-crear-tareas-routes">
<h3><a class="toc-backref" href="#id18">Paso 13: Crear tareas (routes)</a><a class="headerlink" href="#paso-13-crear-tareas-routes" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Editamos el archivo de rutas <strong>taskRoutes.js</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">api</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">taskController</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../controllers/taskController&quot;</span><span class="p">);</span><span class="w"></span>

<span class="c1">// añadir ruta para crear tareas:</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/tasks&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">taskController</span><span class="p">.</span><span class="nx">postTask</span><span class="p">);</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/tasks&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">taskController</span><span class="p">.</span><span class="nx">getTasks</span><span class="p">);</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">api</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>En Postman, crear nueva petición <strong>POST</strong>. Pinchamos en la opción <strong>Body</strong> y dentro en la opción <strong>raw</strong>. A la derecha cambiamos en el selector el valor <strong>Text</strong> por <strong>Json</strong> y añadimos una nueva tarea en la caja:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Ir al supermercado&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;description&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Ir al super a por galletas esta tarde&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>Pinchamos en <strong>Send</strong> y si todo va bien retornará un objeto similar a este:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;task&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;is_complete&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;date_finish&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;630f3ef2cfbc14f7d61f79ab&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;date_created&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;2022-08-31T10:58:58.819Z&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Ir al supermercado&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;description&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Ir al super a por galletas esta tarde&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;__v&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="paso-14-opcional-comprobar-datos-en-studio3t">
<h3><a class="toc-backref" href="#id19">Paso 14 (Opcional): Comprobar datos en Studio3T</a><a class="headerlink" href="#paso-14-opcional-comprobar-datos-en-studio3t" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Abrimos el programa Studio3T y pinchamos en <strong>New Connection</strong> si es la primera vez que lo abrimos.</p></li>
<li><p>añadimos la ruta <strong>mongodb://localhost:27017</strong> y pinchamos en <strong>Next</strong></p></li>
<li><p>Definimos el Connection name por ejemplo <strong>mongo database</strong> y pinchamos en <strong>Save</strong>.</p></li>
<li><p>Al acceder al servidor, si el paso anterior fue bien tendremos una base de datos <strong>task-learn</strong> creada y dentro una colección <strong>tasks</strong> con el documento que creamos en el paso anterior.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Mas adelante veremos como hacer lo mismo conectando una base de datos remota.</p>
</div>
</section>
<section id="paso-15-listar-tareas-controller">
<h3><a class="toc-backref" href="#id20">Paso 15: Listar tareas (controller)</a><a class="headerlink" href="#paso-15-listar-tareas-controller" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Editar la función <strong>getTasks</strong> del archivo <strong>taskController.js</strong></p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">Task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/taskModel&#39;</span><span class="p">);</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">postTask</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Task</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="nx">task</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="nx">task</span><span class="p">.</span><span class="nx">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">description</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">taskStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">task</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">taskStore</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: cannot create task&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">task</span><span class="o">:</span><span class="w"> </span><span class="nx">taskStore</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// editar función para listar tareas, definir como asincrona:</span><span class="w"></span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getTasks</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// recuperar tareas de base de datos:</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">tasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Task</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">sort</span><span class="p">({</span><span class="nx">create_at</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">});</span><span class="w"> </span><span class="c1">// opcional: ordenar resultados con sort por un parámetro seleccionado.</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Agregar condición dentro de find: const tasks = await Task.find({completed: false}).sort({create_at: -1});</span><span class="w"></span>

<span class="w">        </span><span class="c1">// comprobar si hay tareas:</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">tasks</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: Cannot get tasks&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">tasks</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">postTask</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">getTasks</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>Ya teníamos creada la ruta, nos vamos a Postman y ejecutamos la petición GET.</p></li>
<li><p>Creamos mas tareas y volvemos a listar para comprobar que aparecen todas.</p></li>
</ul>
</section>
<section id="paso-16-mostrar-una-tarea-controller">
<h3><a class="toc-backref" href="#id21">Paso 16: Mostrar una tarea (controller)</a><a class="headerlink" href="#paso-16-mostrar-una-tarea-controller" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Para recuperar una tarea por su id, creamos la tarea <strong>getTask</strong> en el archivo <strong>taskController.js</strong></p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">Task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/taskModel&#39;</span><span class="p">);</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">postTask</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Task</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="nx">task</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="nx">task</span><span class="p">.</span><span class="nx">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">description</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">taskStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">task</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">taskStore</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: cannot create task&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">task</span><span class="o">:</span><span class="w"> </span><span class="nx">taskStore</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getTasks</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">tasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Task</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">sort</span><span class="p">({</span><span class="nx">create_at</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">});</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">tasks</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: Cannot get tasks&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">tasks</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// recuperar una sola tarea:</span><span class="w"></span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getTask</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="c1">// recuperar el id:</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">taskId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// se hace un findById con el id recibido por request:</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Task</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">taskId</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">task</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: Task doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">task</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">postTask</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">getTasks</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">getTask</span><span class="w"> </span><span class="c1">// exportar modulo</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="paso-17-mostrar-una-tarea-router">
<h3><a class="toc-backref" href="#id22">Paso 17: Mostrar una tarea (router)</a><a class="headerlink" href="#paso-17-mostrar-una-tarea-router" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Añadir la ruta al archivo <strong>taskRouter.js</strong></p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">api</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">taskController</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../controllers/taskController&quot;</span><span class="p">);</span><span class="w"></span>

<span class="nx">api</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/tasks&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">taskController</span><span class="p">.</span><span class="nx">postTask</span><span class="p">);</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/tasks&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">taskController</span><span class="p">.</span><span class="nx">getTasks</span><span class="p">);</span><span class="w"></span>
<span class="c1">// listar una tarea:</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/tasks/:id&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">taskController</span><span class="p">.</span><span class="nx">getTask</span><span class="p">);</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">api</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>Crear una nueva request en Postman y pasarle una nueva variable <strong>{{task_id}}</strong> con el campo <strong>_id</strong> de una tarea.</p></li>
</ul>
</section>
<section id="paso-18-actualizar-datos-de-una-tarea-controller">
<h3><a class="toc-backref" href="#id23">Paso 18: Actualizar datos de una tarea (controller)</a><a class="headerlink" href="#paso-18-actualizar-datos-de-una-tarea-controller" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Ahora se va a añadir la función <strong>putTask</strong> para modificar los datos de la tarea, editamos <strong>taskController.js</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">Task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/taskModel&#39;</span><span class="p">);</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">postTask</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Task</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="nx">task</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="nx">task</span><span class="p">.</span><span class="nx">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">description</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">taskStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">task</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">taskStore</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: cannot create task&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">task</span><span class="o">:</span><span class="w"> </span><span class="nx">taskStore</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getTasks</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">tasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Task</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">sort</span><span class="p">({</span><span class="nx">create_at</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">});</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">tasks</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: Cannot get tasks&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">tasks</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getTask</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">taskId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Task</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">taskId</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">task</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: Task doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">task</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// crear la función (no asincrona) para actualizar tareas:</span><span class="w"></span>
<span class="kd">function</span><span class="w"> </span><span class="nx">putTask</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="c1">// recuperar el id:</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">taskId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// recuperar parametros a actualizar:</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// recuperar la tarea y ejecutar un callback:</span><span class="w"></span>
<span class="w">        </span><span class="nx">Task</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">taskId</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">taskData</span><span class="p">)=&gt;{</span><span class="w"></span>

<span class="w">            </span><span class="c1">// comprobar si hay errores al recuperar tarea:</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">taskData</span><span class="p">){</span><span class="w"></span>
<span class="w">                    </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: Task doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>

<span class="w">                    </span><span class="c1">// recuperar parametros a modificar:</span><span class="w"></span>
<span class="w">                    </span><span class="nx">taskData</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="nx">taskData</span><span class="p">.</span><span class="nx">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">description</span><span class="p">;</span><span class="w"></span>

<span class="w">                    </span><span class="c1">// si todo va bien, actualizar tarea y ejecutar un callback:</span><span class="w"></span>
<span class="w">                    </span><span class="nx">Task</span><span class="p">.</span><span class="nx">findByIdAndUpdate</span><span class="p">(</span><span class="nx">taskId</span><span class="p">,</span><span class="w"> </span><span class="nx">taskData</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)=&gt;{</span><span class="w"></span>
<span class="w">                        </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="nx">err</span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">){</span><span class="w"></span>
<span class="w">                            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: task doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">task</span><span class="o">:</span><span class="w"> </span><span class="nx">taskData</span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="p">});</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">postTask</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">getTasks</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">getTask</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">putTask</span><span class="w"> </span><span class="c1">// exportar modulo</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="paso-19-actualizar-datos-de-una-tarea-router">
<h3><a class="toc-backref" href="#id24">Paso 19: Actualizar datos de una tarea (router)</a><a class="headerlink" href="#paso-19-actualizar-datos-de-una-tarea-router" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Crear una nueva ruta en <strong>taskRoutes.js</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../app&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">api</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">taskController</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../controllers/taskController&quot;</span><span class="p">);</span><span class="w"></span>

<span class="nx">api</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/tasks&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">taskController</span><span class="p">.</span><span class="nx">postTask</span><span class="p">);</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/tasks&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">taskController</span><span class="p">.</span><span class="nx">getTasks</span><span class="p">);</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/tasks/:id&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">taskController</span><span class="p">.</span><span class="nx">getTask</span><span class="p">);</span><span class="w"></span>
<span class="c1">// actualizar una tarea:</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s2">&quot;/tasks/:id&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">taskController</span><span class="p">.</span><span class="nx">putTask</span><span class="p">);</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">api</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>En Postman, crear nueva petición <strong>PUT</strong> con el id de una tarea. Pinchamos en la opción <strong>Body</strong> y dentro en la opción <strong>raw</strong>. A la derecha cambiamos en el selector el valor <strong>Text</strong> por <strong>Json</strong> y añadimos una nueva tarea en la caja:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Cambiar aceite del coche&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;description&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Llevar coche al taller a que le cambien el aceite&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="paso-18-eliminar-una-tarea-controller">
<h3><a class="toc-backref" href="#id25">Paso 18: Eliminar una tarea (controller)</a><a class="headerlink" href="#paso-18-eliminar-una-tarea-controller" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Ahora se va a añadir la función <strong>deleteTask</strong> para eliminar la tarea, editamos <strong>taskController.js</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">Task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/taskModel&#39;</span><span class="p">);</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">postTask</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Task</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="nx">task</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="nx">task</span><span class="p">.</span><span class="nx">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">description</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">taskStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">task</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">taskStore</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: cannot create task&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">task</span><span class="o">:</span><span class="w"> </span><span class="nx">taskStore</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getTasks</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">tasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Task</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">sort</span><span class="p">({</span><span class="nx">create_at</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">});</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">tasks</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: Cannot get tasks&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">tasks</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getTask</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">taskId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Task</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">taskId</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">task</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: Task doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">task</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">function</span><span class="w"> </span><span class="nx">putTask</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">taskId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">Task</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">taskId</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">taskData</span><span class="p">)=&gt;{</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>

<span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">taskData</span><span class="p">){</span><span class="w"></span>
<span class="w">                    </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: Task doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="nx">taskData</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="nx">taskData</span><span class="p">.</span><span class="nx">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">description</span><span class="p">;</span><span class="w"></span>

<span class="w">                    </span><span class="nx">Task</span><span class="p">.</span><span class="nx">findByIdAndUpdate</span><span class="p">(</span><span class="nx">taskId</span><span class="p">,</span><span class="w"> </span><span class="nx">taskData</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)=&gt;{</span><span class="w"></span>
<span class="w">                        </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="nx">err</span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">){</span><span class="w"></span>
<span class="w">                            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: task doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">task</span><span class="o">:</span><span class="w"> </span><span class="nx">taskData</span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="p">});</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// función para eliminar tarea:</span><span class="w"></span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">deleteTask</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="c1">// recuperar el id:</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">taskId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// realizar delete:</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Task</span><span class="p">.</span><span class="nx">findByIdAndDelete</span><span class="p">(</span><span class="nx">taskId</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">task</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: Task doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Task successfully deleted&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">postTask</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">getTasks</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">getTask</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">putTask</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">deleteTask</span><span class="w">  </span><span class="c1">// exportar modulo</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="paso-19-eliminar-una-tarea-router">
<h3><a class="toc-backref" href="#id26">Paso 19: Eliminar una tarea (router)</a><a class="headerlink" href="#paso-19-eliminar-una-tarea-router" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Crear una nueva ruta en <strong>taskRoutes.js</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../app&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">api</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">taskController</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../controllers/taskController&quot;</span><span class="p">);</span><span class="w"></span>

<span class="nx">api</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/tasks&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">taskController</span><span class="p">.</span><span class="nx">postTask</span><span class="p">);</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/tasks&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">taskController</span><span class="p">.</span><span class="nx">getTasks</span><span class="p">);</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/tasks/:id&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">taskController</span><span class="p">.</span><span class="nx">getTask</span><span class="p">);</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s2">&quot;/tasks/:id&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">taskController</span><span class="p">.</span><span class="nx">putTask</span><span class="p">);</span><span class="w"></span>
<span class="c1">// ruta para borrar tareas:</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="ow">delete</span><span class="p">(</span><span class="s2">&quot;/tasks/:id&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">taskController</span><span class="p">.</span><span class="nx">deleteTask</span><span class="p">);</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">api</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>Crear nueva request en Postman de tipo DELETE y ejecutar ruta con el id de una Tarea.</p></li>
<li><p>Si repetimos nos debería dar error porque ya no existe. De igual forma podemos listar tareas y recuperar tarea. Si la respuesta da un mensaje de error es que se ha borrado la tarea.</p></li>
<li><p>También se puede verificar desde Studio3T si ya no existe.</p></li>
</ul>
</section>
<section id="paso-20-cambiar-estado-de-tarea-controller">
<h3><a class="toc-backref" href="#id27">Paso 20: Cambiar estado de tarea (controller)</a><a class="headerlink" href="#paso-20-cambiar-estado-de-tarea-controller" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Cambiar estado de tarea a terminada y su fecha de finalización, editar <strong>taskRoutes.js</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">Task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/taskModel&#39;</span><span class="p">);</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">postTask</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Task</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="nx">task</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="nx">task</span><span class="p">.</span><span class="nx">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">description</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">taskStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">task</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">taskStore</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: cannot create task&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">task</span><span class="o">:</span><span class="w"> </span><span class="nx">taskStore</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getTasks</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">tasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Task</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">sort</span><span class="p">({</span><span class="nx">create_at</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">});</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">tasks</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: Cannot get tasks&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">tasks</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getTask</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">taskId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Task</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">taskId</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">task</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: Task doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">task</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">function</span><span class="w"> </span><span class="nx">putTask</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">taskId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">Task</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">taskId</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">taskData</span><span class="p">)=&gt;{</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">taskData</span><span class="p">){</span><span class="w"></span>
<span class="w">                    </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: Task doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>

<span class="w">                    </span><span class="nx">taskData</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="nx">taskData</span><span class="p">.</span><span class="nx">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">description</span><span class="p">;</span><span class="w"></span>

<span class="w">                    </span><span class="nx">Task</span><span class="p">.</span><span class="nx">findByIdAndUpdate</span><span class="p">(</span><span class="nx">taskId</span><span class="p">,</span><span class="w"> </span><span class="nx">taskData</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)=&gt;{</span><span class="w"></span>
<span class="w">                        </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="nx">err</span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">){</span><span class="w"></span>
<span class="w">                            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: task doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">task</span><span class="o">:</span><span class="w"> </span><span class="nx">taskData</span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="p">});</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">deleteTask</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">taskId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Task</span><span class="p">.</span><span class="nx">findByIdAndDelete</span><span class="p">(</span><span class="nx">taskId</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">task</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: Task doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Task successfully deleted&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// cambiar estado de tarea:</span><span class="w"></span>
<span class="kd">function</span><span class="w"> </span><span class="nx">changeTask</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="c1">// recuperar id de la tarea:</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">taskId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// buscar tarea a modificar y ejecutar callback:</span><span class="w"></span>
<span class="w">        </span><span class="nx">Task</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">taskId</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">taskData</span><span class="p">)=&gt;{</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">taskData</span><span class="p">){</span><span class="w"></span>
<span class="w">                    </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: Task doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="c1">// si existe la tarea cambiar campos is_complete y date_finish</span><span class="w"></span>
<span class="w">                    </span><span class="nx">taskData</span><span class="p">.</span><span class="nx">is_complete</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="nx">taskData</span><span class="p">.</span><span class="nx">date_finish</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span><span class="w"></span>
<span class="w">                    </span><span class="c1">// realizar cambios:</span><span class="w"></span>
<span class="w">                    </span><span class="nx">Task</span><span class="p">.</span><span class="nx">findByIdAndUpdate</span><span class="p">(</span><span class="nx">taskId</span><span class="p">,</span><span class="w"> </span><span class="nx">taskData</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)=&gt;{</span><span class="w"></span>
<span class="w">                        </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="nx">err</span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">){</span><span class="w"></span>
<span class="w">                            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: user doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">task</span><span class="o">:</span><span class="w"> </span><span class="nx">taskData</span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="p">});</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">postTask</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">getTasks</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">getTask</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">putTask</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">deleteTask</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">changeTask</span><span class="w">  </span><span class="c1">// exportar modulo</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="paso-21-cambiar-estado-de-tarea-router">
<h3><a class="toc-backref" href="#id28">Paso 21: Cambiar estado de tarea (router)</a><a class="headerlink" href="#paso-21-cambiar-estado-de-tarea-router" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Crear una nueva ruta en <strong>taskRoutes.js</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../app&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">api</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">taskController</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../controllers/taskController&quot;</span><span class="p">);</span><span class="w"></span>

<span class="nx">api</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/tasks&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">taskController</span><span class="p">.</span><span class="nx">postTask</span><span class="p">);</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/tasks&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">taskController</span><span class="p">.</span><span class="nx">getTasks</span><span class="p">);</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/tasks/:id&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">taskController</span><span class="p">.</span><span class="nx">getTask</span><span class="p">);</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s2">&quot;/tasks/:id&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">taskController</span><span class="p">.</span><span class="nx">putTask</span><span class="p">);</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="ow">delete</span><span class="p">(</span><span class="s2">&quot;/tasks/:id&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">taskController</span><span class="p">.</span><span class="nx">deleteTask</span><span class="p">);</span><span class="w"></span>
<span class="c1">// ruta para actualizar tareas:</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">patch</span><span class="p">(</span><span class="s2">&quot;/tasks/:id&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">taskController</span><span class="p">.</span><span class="nx">changeTask</span><span class="p">);</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">api</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>Crear una nueva request con Postman de tipo PATCH y pasarle el id de una tarea. (Si estas usando variables deberás cambiar la última que usaste ya que seguro que es la tarea que borraste).</p></li>
</ul>
</section>
<section id="paso-22-subir-cambios-a-github">
<h3><a class="toc-backref" href="#id29">Paso 22: Subir cambios a GitHub</a><a class="headerlink" href="#paso-22-subir-cambios-a-github" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Parar depuración de Visual studio code.</p></li>
<li><p>Añadir cambios: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">add</span> <span class="pre">.</span></code></p></li>
<li><p>Realizar un commit: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">commit</span> <span class="pre">-am</span> <span class="pre">&quot;Phase</span> <span class="pre">1</span> <span class="pre">complete&quot;</span></code></p></li>
<li><p>Subir cambios a Github con el nombre de la rama actual: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">push</span> <span class="pre">origin</span> <span class="pre">feature/phase-1-task-system</span></code></p></li>
<li><p>Desde gitHub presionar botón <strong>Compare &amp; pull request</strong>.</p></li>
<li><p>cambiar rama base <strong>master</strong> por <strong>developer</strong> y pulsar <strong>Create pull request</strong></p></li>
<li><p>Pulsar en <strong>Merge pull request</strong> y a continuación en <strong>Confirm merge</strong>.</p></li>
<li><p>Una vez terminado volvemos a local y cambiamos de rama a developer: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">checkout</span> <span class="pre">developer</span></code></p></li>
<li><p>Actualizamos rama developer: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">pull</span> <span class="pre">origin</span> <span class="pre">developer</span></code></p></li>
</ul>
<p>Y con esto concluye la primera fase del proyecto.</p>
<hr><br></section>
</section>
<section id="fase-2-usuarios-y-securizacion">
<h2><a class="toc-backref" href="#id30">Fase 2: Usuarios y securización</a><a class="headerlink" href="#fase-2-usuarios-y-securizacion" title="Enlazar permanentemente con este título">¶</a></h2>
<p>En esta fase se va a crear el CRUD de usuarios, la autenticación vía JWT, securizar los endpoints y establecer
una relación entre tareas y usuarios para saber que tareas pertenece a cada usuario.</p>
<section id="paso-1-preparar-proyecto">
<h3><a class="toc-backref" href="#id31">Paso 1: Preparar proyecto</a><a class="headerlink" href="#paso-1-preparar-proyecto" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Desde la rama <strong>developer</strong> crear rama <strong>git checkout -b feature/auth-jwt-and-securize-tasks</strong></p></li>
<li><p>Se instalará <cite>moment</cite> para controlar las fechas: <code class="docutils literal notranslate"><span class="pre">npm</span> <span class="pre">install</span> <span class="pre">moment</span> <span class="pre">--save</span></code></p></li>
<li><p>Se instalará <cite>jsonwebtoken</cite> para trabajar con JWT: <code class="docutils literal notranslate"><span class="pre">npm</span> <span class="pre">install</span> <span class="pre">jsonwebtoken</span> <span class="pre">--save</span></code></p></li>
<li><p>Se instalará <cite>bcryptjs</cite> para encriptación de contraseñas: <code class="docutils literal notranslate"><span class="pre">npm</span> <span class="pre">install</span> <span class="pre">bcryptjs</span> <span class="pre">--</span> <span class="pre">save</span></code></p></li>
<li><p>Se instalará <cite>dotenv</cite> para trabajar con variables de entorno: <code class="docutils literal notranslate"><span class="pre">npm</span> <span class="pre">install</span> <span class="pre">dotenv</span> <span class="pre">--save</span></code></p></li>
</ul>
</section>
<section id="paso-2-crear-modelo-de-usuarios">
<h3><a class="toc-backref" href="#id32">Paso 2: Crear modelo de usuarios</a><a class="headerlink" href="#paso-2-crear-modelo-de-usuarios" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>En la carpeta <strong>models</strong> crear el archivo <strong>userModel.js</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kd">const</span><span class="w"> </span><span class="nx">mongoose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongoose&#39;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 2</span><span class="kd">const</span><span class="w"> </span><span class="nx">Schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="kd">const</span><span class="w"> </span><span class="nx">UserSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Schema</span><span class="p">({</span><span class="w"></span>
<span class="linenos"> 5</span><span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 6</span><span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 7</span><span class="w">        </span><span class="nx">require</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="linenos"> 8</span><span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="linenos"> 9</span><span class="w">    </span><span class="nx">lastname</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">10</span><span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="linenos">11</span><span class="w">        </span><span class="nx">require</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="linenos">12</span><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="c1">// email y password serán obligatorios:</span><span class="w"></span>
<span class="linenos">13</span><span class="w">    </span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">14</span><span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="linenos">15</span><span class="w">        </span><span class="nx">require</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="linenos">16</span><span class="w">        </span><span class="nx">unique</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="linenos">17</span><span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="linenos">18</span><span class="w">    </span><span class="nx">password</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">19</span><span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="linenos">20</span><span class="w">        </span><span class="nx">require</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="linenos">21</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">22</span><span class="p">});</span><span class="w"></span>
<span class="linenos">23</span>
<span class="linenos">24</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">UserSchema</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="paso-3-registro-de-usuarios-controller">
<h3><a class="toc-backref" href="#id33">Paso 3: Registro de usuarios (controller)</a><a class="headerlink" href="#paso-3-registro-de-usuarios-controller" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Crear un nuevo controlador en la carpeta <strong>controllers</strong> llamado <strong>userController.js</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// importar el encriptador de contraseñas:</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;bcryptjs&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">User</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/userModel&#39;</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Registro de usuarios:</span><span class="w"></span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">postUser</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">User</span><span class="p">(</span><span class="nx">params</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// comprobar que los campos email y password:</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">params</span><span class="p">.</span><span class="nx">email</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="p">{</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: email cannot be null&quot;</span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">params</span><span class="p">.</span><span class="nx">password</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="p">{</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: password cannot be null&quot;</span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="c1">// revisar si el email esta en uso:</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">emailExists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">email</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="nx">emailExists</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="p">{</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: Email already exists&quot;</span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="c1">// configurar el salt de bcrypt:</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">salt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">genSaltSync</span><span class="p">(</span><span class="mf">10</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="c1">// cifrar la contraseña:</span><span class="w"></span>
<span class="w">        </span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span><span class="w"> </span><span class="nx">salt</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">postUser</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="paso-4-registro-de-usuarios-router">
<h3><a class="toc-backref" href="#id34">Paso 4: Registro de usuarios (router)</a><a class="headerlink" href="#paso-4-registro-de-usuarios-router" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Crear archivo para las rutas en <strong>routes</strong> llamado <strong>userRoutes.js</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// añadir todo el contenido:</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;express&quot;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">userController</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../controllers/userController&#39;</span><span class="p">);</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">api</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span><span class="w"></span>

<span class="c1">// Cargar ruta registro usuarios:</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/register&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">userController</span><span class="p">.</span><span class="nx">postUser</span><span class="p">);</span><span class="w"></span>


<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">api</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="paso-5-registrar-rutas-de-usuarios">
<h3><a class="toc-backref" href="#id35">Paso 5: Registrar rutas de usuarios</a><a class="headerlink" href="#paso-5-registrar-rutas-de-usuarios" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Editar <strong>app.js</strong> y añadir el archivo de rutas:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;express&quot;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">();</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">cors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;cors&#39;</span><span class="p">);</span><span class="w"></span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span><span class="w"></span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">urlencoded</span><span class="p">({</span><span class="nx">extended</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">}));</span><span class="w"></span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cors</span><span class="p">());</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">taskRoutes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/taskRoutes&#39;</span><span class="p">);</span><span class="w"></span>
<span class="c1">// cargar modulo rutas de usuarios:</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">userRoutes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/userRoutes&#39;</span><span class="p">);</span><span class="w"></span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&quot;/api&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">taskRoutes</span><span class="p">);</span><span class="w"></span>
<span class="c1">// cargar rutas de usuarios:</span><span class="w"></span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&quot;/api&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">userRoutes</span><span class="p">);</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">app</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>En la colección postman crear un nuevo directorio para <strong>Tasks</strong> y mover todas las request a el.</p></li>
<li><p>Crear un nuevo directorio llamado <strong>Users</strong> y una nueva petición POST para crear un usuario con la siguiente información en el body:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;email&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;pytonicus@gmail.com&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;password&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;1234&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>Nos devolverá una respuesta similar a esta:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;user&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;email&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;pytonicus@gmail.com&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;password&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;$2a$10$7hUP0JSQWAMjeEMGxw4fMO36p/s20g8.EYJmLo4vuGqIv4Moi.h/K&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;630f6fddb525ceda80fd8e64&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="paso-6-crear-variables-de-entorno">
<h3><a class="toc-backref" href="#id36">Paso 6: Crear variables de entorno</a><a class="headerlink" href="#paso-6-crear-variables-de-entorno" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Antes de poder crear variables de entorno, hay que configurar dotenv. Editamos <strong>index.js</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">mongoose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongoose&#39;</span><span class="p">);</span><span class="w"></span>
<span class="c1">// cargar dotenv:</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">dotenv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;dotenv&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./app&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5000</span><span class="p">;</span><span class="w"></span>

<span class="c1">// ejecutar variables de entorno:</span><span class="w"></span>
<span class="nx">dotenv</span><span class="p">.</span><span class="nx">config</span><span class="p">()</span><span class="w"></span>


<span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;mongodb://localhost:27017/task-learn&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;{</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="nx">err</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Se ha extablecido la conexión a la base de datos&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">});</span><span class="w"></span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Servidor funcionando en: http://localhost:</span><span class="si">${</span><span class="nx">port</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span><span class="w"></span>
<span class="p">});</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>A continuación creamos un archivo en la raiz llamado <strong>.env</strong> y otro archivo <strong>.env.dist</strong> que utilizaremos en el siguiente paso.</p></li>
<li><p>El primer archivo guardará nuestras variables de entorno y el segundo serivrá de referencia ya que <strong>.env</strong> posee información sensible y no va a subirse al repo.</p></li>
<li><p>Añade <strong>.env</strong> en una línea del archivo <strong>.gitignore</strong>:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">node_modules</span><span class="o">/</span>
<span class="o">.</span><span class="n">env</span>
</pre></div>
</div>
</section>
<section id="paso-7-crear-servicio-jwt">
<h3><a class="toc-backref" href="#id37">Paso 7: Crear servicio JWT</a><a class="headerlink" href="#paso-7-crear-servicio-jwt" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Para poder hacer login vamos a crear un nuevo servicio que maneje JWT:</p>
<ul class="simple">
<li><p>Editamos el archivo <strong>.env</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">SECRET_KEY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;2ha9df238dhha87d8vaq&quot;</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>En la raiz del proyecto crear carpeta <strong>services</strong></p></li>
<li><p>Dentro de <strong>services</strong> crear archivo <strong>jwtService.js</strong> y editar:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// importar jwt:</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">jwt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;jsonwebtoken&quot;</span><span class="p">);</span><span class="w"></span>

<span class="c1">// crear token:</span><span class="w"></span>
<span class="kd">function</span><span class="w"> </span><span class="nx">createToken</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span><span class="w"> </span><span class="nx">expiresIn</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="c1">// recuperamos el id y el email del objeto user:</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">email</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// y lo añadimos al payload:</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">email</span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// utilizamos el payload para retornar el token tras iniciar sesión junto a la secret key de nuestras variables de entorno:</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">jwt</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">payload</span><span class="p">,</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRET_KEY</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nx">expiresIn</span><span class="o">:</span><span class="w"> </span><span class="nx">expiresIn</span><span class="p">});</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// crear uan función para decodificar el token:</span><span class="w"></span>
<span class="kd">function</span><span class="w"> </span><span class="nx">decodeToken</span><span class="p">(</span><span class="nx">token</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">jwt</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRET_KEY</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// exportar las dos funciones para crear y decodificar token:</span><span class="w"></span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">createToken</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">decodeToken</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="paso-8-crear-login-controller">
<h3><a class="toc-backref" href="#id38">Paso 8: Crear login (controller)</a><a class="headerlink" href="#paso-8-crear-login-controller" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Crear una función <strong>login</strong> en <strong>userController.js</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;bcryptjs&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">User</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/userModel&#39;</span><span class="p">);</span><span class="w"></span>
<span class="c1">// importar servicio jwt:</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">jwt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../services/jwtService&#39;</span><span class="p">);</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">postUser</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">User</span><span class="p">(</span><span class="nx">params</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">params</span><span class="p">.</span><span class="nx">email</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="p">{</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: email cannot be null&quot;</span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">params</span><span class="p">.</span><span class="nx">password</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="p">{</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: password cannot be null&quot;</span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">emailExists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">email</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="nx">emailExists</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="p">{</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: Email already exists&quot;</span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">salt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">genSaltSync</span><span class="p">(</span><span class="mf">10</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span><span class="w"> </span><span class="nx">salt</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// crear función para hacer login:</span><span class="w"></span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">login</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="c1">// recuperar el email y password del body:</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="nx">email</span><span class="p">,</span><span class="w"> </span><span class="nx">password</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// buscamos si existe el usuario por su email haciendo un callback asincrono:</span><span class="w"></span>
<span class="w">        </span><span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="nx">email</span><span class="p">},</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">userData</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// si el usuario no existe se lanza un mensaje de error:</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">userData</span><span class="p">){</span><span class="w"></span>
<span class="w">                    </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: email doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="c1">// comprobar la contraseña recibida con la contraseña encriptada:</span><span class="w"></span>
<span class="w">                    </span><span class="kd">const</span><span class="w"> </span><span class="nx">passwordCorrect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span><span class="w"> </span><span class="nx">userData</span><span class="p">.</span><span class="nx">password</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="c1">// si la contraseña no es correcta avisar:</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">passwordCorrect</span><span class="p">){</span><span class="w"></span>
<span class="w">                        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">403</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: incorrect password&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="c1">// creamos el token que lleva el usuario la fecha de expiración del token (12 horas):</span><span class="w"></span>
<span class="w">                        </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">jwt</span><span class="p">.</span><span class="nx">createToken</span><span class="p">(</span><span class="nx">userData</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;24h&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">                        </span><span class="c1">// se responde con  el token:</span><span class="w"></span>
<span class="w">                        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">token</span><span class="o">:</span><span class="w"> </span><span class="nx">token</span><span class="p">});</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>

<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">});</span><span class="w"></span>




<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">postUser</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">login</span><span class="w"> </span><span class="c1">// exportar modulo</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="paso-9-crear-login-router">
<h3><a class="toc-backref" href="#id39">Paso 9: Crear login (router)</a><a class="headerlink" href="#paso-9-crear-login-router" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Crear la ruta <strong>login</strong> en <strong>userRoutes.js</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;express&quot;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">userController</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../controllers/userController&#39;</span><span class="p">);</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">api</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span><span class="w"></span>

<span class="nx">api</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/register&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">userController</span><span class="p">.</span><span class="nx">postUser</span><span class="p">);</span><span class="w"></span>
<span class="c1">// crear ruta login:</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/login&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">userController</span><span class="p">.</span><span class="nx">login</span><span class="p">);</span><span class="w"></span>


<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">api</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>Ahora creamos en Postman una request tipo POST con la información de nuestro usuario en el body:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;email&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;pytonicus@gmail.com&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;password&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;1234&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>Esto devolverá una respuesta similar a esta:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;token&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjYzMGY2ZmRkYjUyNWNlZGE4MGZkOGU2NCIsImVtYWlsIjoicHl0b25pY3VzQGdtYWlsLmNvbSIsImlhdCI6MTY2MTk1NzE1NywiZXhwIjoxNjYyMDQzNTU3fQ.V_L-gxc6poL-FqAYbGllkkXJgzvUPwKCDpMNPgfDYlo&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>Se puede comprobar el token en la página <a class="reference external" href="http://jwt.io">http://jwt.io</a> pegando el resultado de nuestro token mas abajo nos dirá los datos del usuario que hemos usado para generar dicho token.</p></li>
</ul>
</section>
<section id="paso-10-crear-middleware-para-securizar-rutas">
<h3><a class="toc-backref" href="#id40">Paso 10: Crear middleware para securizar rutas</a><a class="headerlink" href="#paso-10-crear-middleware-para-securizar-rutas" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Para securizar las rutas del proyectos creamos una carpeta en la raiz llamada <strong>middlewares</strong> y dentro de ella el archivo <strong>authMiddleware.js</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// importamos moment para las fechas:</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">moment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;moment&#39;</span><span class="p">);</span><span class="w"></span>
<span class="c1">// importamos el servicio que hemos creado con jwt:</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">jwt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../services/jwtService&#39;</span><span class="p">);</span><span class="w"></span>

<span class="c1">// crear una función (next es una función que continuará el proceso si todo va bien):</span><span class="w"></span>
<span class="kd">function</span><span class="w"> </span><span class="nx">secureRoute</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="c1">// si no recibimos el token por el apartado autorización del header:</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="c1">// damos error de autorización:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">403</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: authentication credentials are missing&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// si tenemos la cabecera con el token lo guardamos:</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[&#39;&quot;]+/g</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// reemplazar las comillas simples por nada</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// decodificamos el token:</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">jwt</span><span class="p">.</span><span class="nx">decodeToken</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRET_KEY</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// si el token ha caducado respondemos con error:</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">exp</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">moment</span><span class="p">().</span><span class="nx">unix</span><span class="p">()){</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: token has expired&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// si todo va bien le pasamos el payload al usuario y avanzamos a la función ext:</span><span class="w"></span>
<span class="w">        </span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">payload</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="nx">next</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: Invalid token&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// exportar la función:</span><span class="w"></span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">secureRoute</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="paso-11-proteger-endpoints-de-tareas">
<h3><a class="toc-backref" href="#id41">Paso 11: Proteger endpoints de tareas</a><a class="headerlink" href="#paso-11-proteger-endpoints-de-tareas" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Añadir el middleware a cada endpoint en <strong>taskRoutes.js</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../app&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">api</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span><span class="w"></span>
<span class="c1">// importar el middleware:</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">authMiddleware</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../middlewares/authMiddleware&quot;</span><span class="p">);</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">taskController</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;../controllers/taskController&quot;</span><span class="p">);</span><span class="w"></span>

<span class="c1">// añadir el middleware a todas las rutas:</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/tasks&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">authMiddleware</span><span class="p">.</span><span class="nx">secureRoute</span><span class="p">],</span><span class="w"> </span><span class="nx">taskController</span><span class="p">.</span><span class="nx">postTask</span><span class="p">);</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/tasks&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">authMiddleware</span><span class="p">.</span><span class="nx">secureRoute</span><span class="p">],</span><span class="w"> </span><span class="nx">taskController</span><span class="p">.</span><span class="nx">getTasks</span><span class="p">);</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/tasks/:id&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">authMiddleware</span><span class="p">.</span><span class="nx">secureRoute</span><span class="p">],</span><span class="w"> </span><span class="nx">taskController</span><span class="p">.</span><span class="nx">getTask</span><span class="p">);</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s2">&quot;/tasks/:id&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">authMiddleware</span><span class="p">.</span><span class="nx">secureRoute</span><span class="p">],</span><span class="w"> </span><span class="nx">taskController</span><span class="p">.</span><span class="nx">putTask</span><span class="p">);</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="ow">delete</span><span class="p">(</span><span class="s2">&quot;/tasks/:id&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">authMiddleware</span><span class="p">.</span><span class="nx">secureRoute</span><span class="p">],</span><span class="w"> </span><span class="nx">taskController</span><span class="p">.</span><span class="nx">deleteTask</span><span class="p">);</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">patch</span><span class="p">(</span><span class="s2">&quot;/tasks/:id&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">authMiddleware</span><span class="p">.</span><span class="nx">secureRoute</span><span class="p">],</span><span class="w"> </span><span class="nx">taskController</span><span class="p">.</span><span class="nx">changeTask</span><span class="p">);</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">api</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>Probar a recuperar listado de tareas en Postman, si muestra el mensaje <strong>Error: authentication credentials are missing</strong> todo va bien.</p></li>
<li><p>Creamos una variable en <strong>Task Learn Envionment</strong> llamada <strong>auth_token</strong> y pegamos el token que nos devolvió login. (cambiar CURRENT VALUE cuando esté caducado).</p></li>
<li><p>En cada request de la carpeta <strong>Tasks</strong>, pinchamos en la pestaña <strong>Authorization</strong>  y seleccionamos en <strong>Type</strong> la opción <strong>API Key</strong>.</p></li>
<li><p>En <strong>Key</strong> escribimos: Authorization y en <strong>Value</strong> pegamos la variable <strong>{{auth_token}}</strong> o el token que nos devolvió el login.</p></li>
</ul>
<p>Ahora están todas las rutas aseguradas. Será necesario tener un token válido para poder trabajar con ellas.</p>
</section>
<section id="paso-12-relacionar-tareas-con-usuarios">
<h3><a class="toc-backref" href="#id42">Paso 12: Relacionar tareas con usuarios</a><a class="headerlink" href="#paso-12-relacionar-tareas-con-usuarios" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Relacionar colección de tareas con la de usuarios de modo que cada usuario tenga sus propias tareas:
- Editar modelo <strong>taskModel.js</strong>:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// se importa mongoose para mongodb y se inicializa el modulo schema para hacer un modelo:</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">mongoose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongoose&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">Schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">;</span><span class="w"></span>
<span class="c1">// importar el tipo ObjectId para trabajar con ids</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">ObjectId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Schema</span><span class="p">.</span><span class="nx">ObjectId</span><span class="p">;</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">TaskSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Schema</span><span class="p">({</span><span class="w"></span>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">require</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">require</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="nx">is_complete</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">Boolean</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">require</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="nx">date_created</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">require</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="nx">date_finish</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">require</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="nx">owner</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// crear el campo propietario y hacerlo de tipo ObjectId:</span><span class="w"></span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">require</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">});</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s2">&quot;tasks&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">TaskSchema</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="paso-13-crear-middleware-para-recuperar-usuario">
<h3><a class="toc-backref" href="#id43">Paso 13: Crear middleware para recuperar usuario</a><a class="headerlink" href="#paso-13-crear-middleware-para-recuperar-usuario" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Para poder aprovechar el token y los datos que ofrece, especialmente el ID de usuario. Vamos a añadir la función <strong>getUser</strong> al archivo <strong>authMiddleware.js</strong>:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">moment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;moment&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">jwt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../services/jwtService&#39;</span><span class="p">);</span><span class="w"></span>

<span class="kd">function</span><span class="w"> </span><span class="nx">secureRoute</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">403</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: authentication credentials are missing&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[&#39;&quot;]+/g</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// reemplazar las comillas simples por nada</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">jwt</span><span class="p">.</span><span class="nx">decodeToken</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRET_KEY</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">exp</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">moment</span><span class="p">().</span><span class="nx">unix</span><span class="p">()){</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: token has expired&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">payload</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="nx">next</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: Invalid token&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// crear función para recuperar usuarios:</span><span class="w"></span>
<span class="kd">function</span><span class="w"> </span><span class="nx">getUser</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="c1">// recuperar token:</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[&#39;&quot;]+/g</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// decodificar token:</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">jwt</span><span class="p">.</span><span class="nx">decodeToken</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRET_KEY</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// retornar el payload:</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">payload</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">secureRoute</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">getUser</span><span class="w"> </span><span class="c1">// exportar modulo</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="paso-14-modificar-modulos-de-controlador-task">
<h3><a class="toc-backref" href="#id44">Paso 14: Modificar modulos de controlador task</a><a class="headerlink" href="#paso-14-modificar-modulos-de-controlador-task" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Ahora se va a modificar el controlador <strong>taskController.js</strong> para validar el propietario:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">Task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/taskModel&#39;</span><span class="p">);</span><span class="w"></span>
<span class="c1">// cargar middleware authMiddleware:</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">authMiddleware</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../middlewares/authMiddleware&#39;</span><span class="p">);</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">postTask</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="c1">// recuperar usuario actual a través del token:</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">authMiddleware</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Task</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="nx">task</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="nx">task</span><span class="p">.</span><span class="nx">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">description</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// añadir el owner:</span><span class="w"></span>
<span class="w">    </span><span class="nx">task</span><span class="p">.</span><span class="nx">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">taskStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">task</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">taskStore</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: cannot create task&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">task</span><span class="o">:</span><span class="w"> </span><span class="nx">taskStore</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getTasks</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="c1">// recuperar usuario actual a través del token:</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">authMiddleware</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">tasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Task</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">owner</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">}).</span><span class="nx">sort</span><span class="p">({</span><span class="nx">create_at</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">});</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">tasks</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: Cannot get tasks&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">tasks</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getTask</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">taskId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// recuperar usuario actual a través del token:</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">authMiddleware</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">Task</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">taskId</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">task</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: Task doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="nx">task</span><span class="p">.</span><span class="nx">owner</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">){</span><span class="w"> </span><span class="c1">// añadir validación para comprobar que somos el propietario sino dará 403:</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">403</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Forbidden - Access to this resource on the server is denied!&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">task</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// convertir esta función en asincrona para el middleware:</span><span class="w"></span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">putTask</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">taskId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// recuperar usuario actual a través del token:</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">authMiddleware</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">Task</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">taskId</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">taskData</span><span class="p">)=&gt;{</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">taskData</span><span class="p">){</span><span class="w"></span>
<span class="w">                    </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: Task doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>

<span class="w">                    </span><span class="nx">taskData</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="nx">taskData</span><span class="p">.</span><span class="nx">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">description</span><span class="p">;</span><span class="w"></span>

<span class="w">                    </span><span class="nx">Task</span><span class="p">.</span><span class="nx">findByIdAndUpdate</span><span class="p">(</span><span class="nx">taskId</span><span class="p">,</span><span class="w"> </span><span class="nx">taskData</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)=&gt;{</span><span class="w"></span>
<span class="w">                        </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="nx">err</span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">){</span><span class="w"></span>
<span class="w">                            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: task doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="nx">taskData</span><span class="p">.</span><span class="nx">owner</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">){</span><span class="w"> </span><span class="c1">// añadir validación para comprobar que somos el propietario sino dará 403:</span><span class="w"></span>
<span class="w">                            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">403</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Forbidden - Access to this resource on the server is denied!&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">task</span><span class="o">:</span><span class="w"> </span><span class="nx">taskData</span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="p">});</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">deleteTask</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">taskId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// recuperar usuario actual a través del token:</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">authMiddleware</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// mejorar la seguridad a la hora de eliminar con un callback:</span><span class="w"></span>
<span class="w">        </span><span class="nx">Task</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">taskId</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">taskData</span><span class="p">)=&gt;{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">taskData</span><span class="p">){</span><span class="w"></span>
<span class="w">                    </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: Task doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="nx">taskData</span><span class="p">.</span><span class="nx">owner</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">){</span><span class="w"> </span><span class="c1">// añadir validación para comprobar que somos el propietario sino dará 403:</span><span class="w"></span>
<span class="w">                    </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">403</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Forbidden - Access to this resource on the server is denied!&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="nx">Task</span><span class="p">.</span><span class="nx">findByIdAndDelete</span><span class="p">(</span><span class="nx">taskId</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">){</span><span class="w"></span>
<span class="w">                            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: task doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Task successfully deleted&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="p">});</span><span class="w"></span>

<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">});</span><span class="w"></span>


<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// convertir esta función en asíncrona:</span><span class="w"></span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">changeTask</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">taskId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// recuperar usuario actual a través del token:</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">authMiddleware</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">Task</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">taskId</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">taskData</span><span class="p">)=&gt;{</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">taskData</span><span class="p">){</span><span class="w"></span>
<span class="w">                    </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: Task doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="nx">taskData</span><span class="p">.</span><span class="nx">owner</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">){</span><span class="w"> </span><span class="c1">// añadir validación para comprobar que somos el propietario sino dará 403:</span><span class="w"></span>
<span class="w">                    </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">403</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Forbidden - Access to this resource on the server is denied!&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="nx">taskData</span><span class="p">.</span><span class="nx">is_complete</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="nx">taskData</span><span class="p">.</span><span class="nx">date_finish</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span><span class="w"></span>
<span class="w">                    </span><span class="nx">Task</span><span class="p">.</span><span class="nx">findByIdAndUpdate</span><span class="p">(</span><span class="nx">taskId</span><span class="p">,</span><span class="w"> </span><span class="nx">taskData</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)=&gt;{</span><span class="w"></span>
<span class="w">                        </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="nx">err</span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">){</span><span class="w"></span>
<span class="w">                            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: task doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="nx">taskData</span><span class="p">.</span><span class="nx">owner</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">){</span><span class="w"> </span><span class="c1">// añadir validación para comprobar que somos el propietario sino dará 403:</span><span class="w"></span>
<span class="w">                            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">403</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Forbidden - Access to this resource on the server is denied!&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">task</span><span class="o">:</span><span class="w"> </span><span class="nx">taskData</span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="p">});</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">postTask</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">getTasks</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">getTask</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">putTask</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">deleteTask</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">changeTask</span><span class="w">  </span><span class="c1">// exportar modulo</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>Ahora las tareas que vayas creando tendrán tu id de usuario.</p></li>
<li><p>Si intentas ver otra tarea, actualizarla o borrarla te dará un error 403.</p></li>
</ul>
</section>
<section id="paso-15-subir-cambios-a-github">
<h3><a class="toc-backref" href="#id45">Paso 15: Subir cambios a GitHub</a><a class="headerlink" href="#paso-15-subir-cambios-a-github" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Parar depuración de Visual studio code.</p></li>
<li><p>Añadir cambios: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">add</span> <span class="pre">.</span></code></p></li>
<li><p>Realizar un commit: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">commit</span> <span class="pre">-am</span> <span class="pre">&quot;Phase</span> <span class="pre">2</span> <span class="pre">complete&quot;</span></code></p></li>
<li><p>Subir cambios a Github con el nombre de la rama actual: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">push</span> <span class="pre">origin</span> <span class="pre">feature/auth-jwt-and-securize-tasks</span></code></p></li>
<li><p>Desde gitHub presionar botón <strong>Compare &amp; pull request</strong>.</p></li>
<li><p>cambiar rama base <strong>master</strong> por <strong>developer</strong> y pulsar <strong>Create pull request</strong></p></li>
<li><p>Pulsar en <strong>Merge pull request</strong> y a continuación en <strong>Confirm merge</strong>.</p></li>
<li><p>Una vez terminado volvemos a local y cambiamos de rama a developer: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">checkout</span> <span class="pre">developer</span></code></p></li>
<li><p>Actualizamos rama developer: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">pull</span> <span class="pre">origin</span> <span class="pre">developer</span></code></p></li>
</ul>
<p>Y con esto concluye la segunda fase del proyecto.</p>
<hr><br></section>
</section>
<section id="fase-3-recuperacion-de-contrasenas">
<h2><a class="toc-backref" href="#id46">Fase 3: Recuperación de contraseñas</a><a class="headerlink" href="#fase-3-recuperacion-de-contrasenas" title="Enlazar permanentemente con este título">¶</a></h2>
<p>En esta fase se va a crear un endpoint para recuperar contraseñas usando el email del usuario.</p>
<section id="id1">
<h3><a class="toc-backref" href="#id47">Paso 2: Preparar proyecto</a><a class="headerlink" href="#id1" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Desde la rama <strong>developer</strong> crear rama <strong>git checkout -b feature/create-recovery-method</strong></p></li>
<li><p>Instalar nodemailer: <code class="docutils literal notranslate"><span class="pre">npm</span> <span class="pre">install</span> <span class="pre">nodemailer</span> <span class="pre">--save</span></code></p></li>
<li><p>Crear cuenta en: <a class="reference external" href="https://mailtrap.io">https://mailtrap.io</a></p></li>
</ul>
</section>
<section id="paso-3-enviar-email-controller">
<h3><a class="toc-backref" href="#id48">Paso 3: Enviar email (controller)</a><a class="headerlink" href="#paso-3-enviar-email-controller" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Lo primero será editar las variables de entorno y añadir los datos de nuestro servidor de email:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;2ha9df238dhha87d8vaq&quot;</span>
<span class="c1"># Añadir datos de configuración de servicio email:</span>
<span class="n">EMAIL_HOST</span> <span class="o">=</span> <span class="s2">&quot;smtp.mailtrap.io&quot;</span>
<span class="n">EMAIL_USER</span> <span class="o">=</span> <span class="s2">&quot;6c40b325c9a698&quot;</span>
<span class="n">EMAIL_PASS</span> <span class="o">=</span> <span class="s2">&quot;53a66737d4e53f&quot;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Hacemos lo propio con el archivo <strong>.env.dist</strong>:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;add your random secret key&quot;</span>
<span class="c1"># Añadir datos de configuración de servicio email:</span>
<span class="n">EMAIL_HOST</span> <span class="o">=</span> <span class="s2">&quot;smtp email server&quot;</span>
<span class="n">EMAIL_USER</span> <span class="o">=</span> <span class="s2">&quot;email user&quot;</span>
<span class="n">EMAIL_PASS</span> <span class="o">=</span> <span class="s2">&quot;email password&quot;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Para enviar el email creamos una nueva función llamada <strong>forgot</strong> en <strong>userController.js</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;bcryptjs&#39;</span><span class="p">);</span><span class="w"></span>
<span class="c1">// importar modulo nodemailer:</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">nodemailer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;nodemailer&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">User</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/userModel&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">jwt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../services/jwtService&#39;</span><span class="p">);</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">postUser</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">User</span><span class="p">(</span><span class="nx">params</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">params</span><span class="p">.</span><span class="nx">email</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="p">{</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: email cannot be null&quot;</span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">params</span><span class="p">.</span><span class="nx">password</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="p">{</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: password cannot be null&quot;</span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">emailExists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">email</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="nx">emailExists</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="p">{</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: Email already exists&quot;</span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">salt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">genSaltSync</span><span class="p">(</span><span class="mf">10</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span><span class="w"> </span><span class="nx">salt</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">login</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="nx">email</span><span class="p">,</span><span class="w"> </span><span class="nx">password</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="nx">email</span><span class="p">},</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">userData</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">userData</span><span class="p">){</span><span class="w"></span>
<span class="w">                    </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: email doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="kd">const</span><span class="w"> </span><span class="nx">passwordCorrect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span><span class="w"> </span><span class="nx">userData</span><span class="p">.</span><span class="nx">password</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">passwordCorrect</span><span class="p">){</span><span class="w"></span>
<span class="w">                        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">403</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: incorrect password&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">jwt</span><span class="p">.</span><span class="nx">createToken</span><span class="p">(</span><span class="nx">userData</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;24h&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">                        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">token</span><span class="o">:</span><span class="w"> </span><span class="nx">token</span><span class="p">});</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>

<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>

<span class="c1">// crear función para recuperar password:</span><span class="w"></span>
<span class="kd">function</span><span class="w"> </span><span class="nx">forgot</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="c1">// recibir parámetros:</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">email</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// si no llega email por parámetros dar error:</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">email</span><span class="p">)</span><span class="k">throw</span><span class="p">{</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: email cannot be null&quot;</span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// recuperar usuario:</span><span class="w"></span>
<span class="w">        </span><span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="nx">email</span><span class="p">},</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">userData</span><span class="p">)=&gt;{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: email doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// crear un token para 1 hora:</span><span class="w"></span>
<span class="w">                </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">jwt</span><span class="p">.</span><span class="nx">createToken</span><span class="p">(</span><span class="nx">userData</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;1h&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="c1">// preparar el email:</span><span class="w"></span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">transporter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nodemailer</span><span class="p">.</span><span class="nx">createTransport</span><span class="p">({</span><span class="w"></span>
<span class="w">                    </span><span class="nx">host</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">EMAIL_HOST</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="nx">port</span><span class="o">:</span><span class="w"> </span><span class="mf">2525</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="nx">auth</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">EMAIL_USER</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="nx">pass</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">EMAIL_PASS</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">});</span><span class="w"></span>


<span class="w">                </span><span class="c1">// preparar las opciones del correo:</span><span class="w"></span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">mailOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// mailtrap no nos da una dirección así que usaremos aquella con la que nos registramos:</span><span class="w"></span>
<span class="w">                    </span><span class="kr">from</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pytonicus@gmail.com&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="nx">to</span><span class="o">:</span><span class="w"> </span><span class="nx">userData</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="nx">subject</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Reestablecer contraseña | Task Learn&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="c1">// ruta del frontend para resetear password:</span><span class="w"></span>
<span class="w">                    </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="sb">`http://localhost:3000/reset/</span><span class="si">${</span><span class="nx">userData</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">token</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="c1">// ruta del frontend</span><span class="w"></span>
<span class="w">                </span><span class="p">};</span><span class="w"></span>

<span class="w">                </span><span class="c1">// enviar email:</span><span class="w"></span>
<span class="w">                </span><span class="nx">transporter</span><span class="p">.</span><span class="nx">sendMail</span><span class="p">(</span><span class="nx">mailOptions</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">response</span><span class="p">)=&gt;{</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Email has send&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// TODO: Crear función para cambiar password haciendo update solo del password.</span><span class="w"></span>


<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">postUser</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">login</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">forgot</span><span class="w"> </span><span class="c1">// exportar modulo</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="paso-4-enviar-email-router">
<h3><a class="toc-backref" href="#id49">Paso 4: Enviar email (router)</a><a class="headerlink" href="#paso-4-enviar-email-router" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Crear el endpoint en el archivo <strong>userRoutes.js</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;express&quot;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">userController</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../controllers/userController&#39;</span><span class="p">);</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">api</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span><span class="w"></span>

<span class="nx">api</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/register&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">userController</span><span class="p">.</span><span class="nx">postUser</span><span class="p">);</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/login&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">userController</span><span class="p">.</span><span class="nx">login</span><span class="p">);</span><span class="w"></span>
<span class="c1">// cargar la ruta para recuperar:</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/forgot&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">userController</span><span class="p">.</span><span class="nx">forgot</span><span class="p">);</span><span class="w"></span>


<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">api</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>Crear nueva request en Postman y probar a enviar un correo en el body:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;email&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;pytonicus@gmail.com&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>Si la respuesta es buena el correo se ha enviado, es probable que nuestro servicio de correo bloquee este email. Por tanto nos vamos a Mailtrap dentro del apartado <strong>Sandbox</strong> abrimos <strong>Inboxes</strong> y comprobamos que el correo se ha enviado con un enlace. Este enlace vamos a trabajarlo en el siguiente paso.</p></li>
</ul>
</section>
<section id="paso-5-reestablecer-contrasena-controller">
<h3><a class="toc-backref" href="#id50">Paso 5: Reestablecer contraseña (controller)</a><a class="headerlink" href="#paso-5-reestablecer-contrasena-controller" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Vamos a crear la función para reestablecer contraseña en el controlador <strong>userController.js</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;bcryptjs&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">nodemailer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;nodemailer&#39;</span><span class="p">);</span><span class="w"></span>
<span class="c1">// importar momentjs:</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">moment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;moment&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">User</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/userModel&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">jwt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../services/jwtService&#39;</span><span class="p">);</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">postUser</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">User</span><span class="p">(</span><span class="nx">params</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">params</span><span class="p">.</span><span class="nx">email</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="p">{</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: email cannot be null&quot;</span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">params</span><span class="p">.</span><span class="nx">password</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="p">{</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: password cannot be null&quot;</span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">emailExists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">email</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="nx">emailExists</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="p">{</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: Email already exists&quot;</span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">salt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">genSaltSync</span><span class="p">(</span><span class="mf">10</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span><span class="w"> </span><span class="nx">salt</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">login</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="nx">email</span><span class="p">,</span><span class="w"> </span><span class="nx">password</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="nx">email</span><span class="p">},</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">userData</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">userData</span><span class="p">){</span><span class="w"></span>
<span class="w">                    </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: email doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="kd">const</span><span class="w"> </span><span class="nx">passwordCorrect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span><span class="w"> </span><span class="nx">userData</span><span class="p">.</span><span class="nx">password</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">passwordCorrect</span><span class="p">){</span><span class="w"></span>
<span class="w">                        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">403</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: incorrect password&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">jwt</span><span class="p">.</span><span class="nx">createToken</span><span class="p">(</span><span class="nx">userData</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;24h&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">                        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">token</span><span class="o">:</span><span class="w"> </span><span class="nx">token</span><span class="p">});</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>

<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>

<span class="kd">function</span><span class="w"> </span><span class="nx">forgot</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">email</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">email</span><span class="p">)</span><span class="k">throw</span><span class="p">{</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: email cannot be null&quot;</span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="nx">email</span><span class="p">},</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">userData</span><span class="p">)=&gt;{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: email doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">jwt</span><span class="p">.</span><span class="nx">createToken</span><span class="p">(</span><span class="nx">userData</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;1h&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">transporter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nodemailer</span><span class="p">.</span><span class="nx">createTransport</span><span class="p">({</span><span class="w"></span>
<span class="w">                    </span><span class="nx">host</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">EMAIL_HOST</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="nx">port</span><span class="o">:</span><span class="w"> </span><span class="mf">2525</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="nx">auth</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">EMAIL_USER</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="nx">pass</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">EMAIL_PASS</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">});</span><span class="w"></span>


<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">mailOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="kr">from</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pytonicus@gmail.com&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="nx">to</span><span class="o">:</span><span class="w"> </span><span class="nx">userData</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="nx">subject</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Reestablecer contraseña | Task Learn&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="sb">`http://localhost:3000/reset/</span><span class="si">${</span><span class="nx">userData</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">token</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="c1">// ruta del frontend</span><span class="w"></span>
<span class="w">                </span><span class="p">};</span><span class="w"></span>

<span class="w">                </span><span class="nx">transporter</span><span class="p">.</span><span class="nx">sendMail</span><span class="p">(</span><span class="nx">mailOptions</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">response</span><span class="p">)=&gt;{</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Email has send&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">resetPassword</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="c1">// recuperar el id y token de usuario:</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">token</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// recuperamos la contraseña por partida doble:</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="nx">newPassword</span><span class="p">,</span><span class="w"> </span><span class="nx">repitePassword</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// decodificar token:</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user_token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">jwt</span><span class="p">.</span><span class="nx">decodeToken</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRET_KEY</span><span class="p">);</span><span class="w"></span>


<span class="w">    </span><span class="c1">// comprobar si las contraseñas son diferentes o el token ha caducado o el id son distintos:</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="nx">user_token</span><span class="p">.</span><span class="nx">exp</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">moment</span><span class="p">().</span><span class="nx">unix</span><span class="p">()){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: token has expired&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="nx">user_token</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">newPassword</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">repitePassword</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">403</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: unauthorized request&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// codificar contraseña:</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">salt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">genSaltSync</span><span class="p">(</span><span class="mf">10</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">newPassword</span><span class="p">,</span><span class="w"> </span><span class="nx">salt</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="c1">// actualizar contraseña nueva:</span><span class="w"></span>
<span class="w">        </span><span class="nx">User</span><span class="p">.</span><span class="nx">findByIdAndUpdate</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nx">password</span><span class="o">:</span><span class="w"> </span><span class="nx">password</span><span class="p">},</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: user doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Password change successfully&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">postUser</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">login</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">forgot</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">resetPassword</span><span class="w"> </span><span class="c1">// exportar modulo</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="paso-6-reestablecer-contrasena-router">
<h3><a class="toc-backref" href="#id51">Paso 6: Reestablecer contraseña (router)</a><a class="headerlink" href="#paso-6-reestablecer-contrasena-router" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Ahora hay que crear la ruta que recibirá dos parámetros en <strong>userController.js</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;express&quot;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">userController</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../controllers/userController&#39;</span><span class="p">);</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">api</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span><span class="w"></span>

<span class="nx">api</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/register&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">userController</span><span class="p">.</span><span class="nx">postUser</span><span class="p">);</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/login&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">userController</span><span class="p">.</span><span class="nx">login</span><span class="p">);</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/forgot&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">userController</span><span class="p">.</span><span class="nx">forgot</span><span class="p">);</span><span class="w"></span>
<span class="c1">// cargar ruta para cambiar contraseña:</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s2">&quot;/reset/:id/:token&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">userController</span><span class="p">.</span><span class="nx">resetPassword</span><span class="p">);</span><span class="w"></span>


<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">api</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>Copiamos los valores de la url que nos envió mailtrap y lo pegamos en dos variables de entorno en Postman.</p></li>
<li><p>Creamos una nueva request para recuperar contraseña de tipo PUT con los siguientes valores en el body:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;newPassword&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;5678&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s2">&quot;repitePassword&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;5678&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Si todo ha ido bien ahora se podrá hacer login con la nueva contraseña.</p>
</section>
<section id="paso-7-subir-cambios-a-github">
<h3><a class="toc-backref" href="#id52">Paso 7: Subir cambios a GitHub</a><a class="headerlink" href="#paso-7-subir-cambios-a-github" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Parar depuración de Visual studio code.</p></li>
<li><p>Añadir cambios: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">add</span> <span class="pre">.</span></code></p></li>
<li><p>Realizar un commit: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">commit</span> <span class="pre">-am</span> <span class="pre">&quot;Phase</span> <span class="pre">3</span> <span class="pre">complete&quot;</span></code></p></li>
<li><p>Subir cambios a Github con el nombre de la rama actual: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">push</span> <span class="pre">origin</span> <span class="pre">feature/create-recovery-method</span></code></p></li>
<li><p>Desde gitHub presionar botón <strong>Compare &amp; pull request</strong>.</p></li>
<li><p>cambiar rama base <strong>master</strong> por <strong>developer</strong> y pulsar <strong>Create pull request</strong></p></li>
<li><p>Pulsar en <strong>Merge pull request</strong> y a continuación en <strong>Confirm merge</strong>.</p></li>
<li><p>Una vez terminado volvemos a local y cambiamos de rama a developer: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">checkout</span> <span class="pre">developer</span></code></p></li>
<li><p>Actualizamos rama developer: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">pull</span> <span class="pre">origin</span> <span class="pre">developer</span></code></p></li>
</ul>
<p>Y con esto concluye la tercera fase del proyecto.</p>
<hr><br></section>
</section>
<section id="fase-4-manejo-de-archivos">
<h2><a class="toc-backref" href="#id53">Fase 4: Manejo de archivos</a><a class="headerlink" href="#fase-4-manejo-de-archivos" title="Enlazar permanentemente con este título">¶</a></h2>
<p>En esta fase vamos a trabajar con archivos de cara al servidor. Se va a añadir las funcionalidades de mostrar datos de usuario y actualizarlos, incluido un avatar.</p>
<section id="id2">
<h3><a class="toc-backref" href="#id54">Paso 1: Preparar proyecto</a><a class="headerlink" href="#id2" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Desde la rama <strong>developer</strong> crear rama <strong>git checkout -b feature/upload-data-service</strong></p></li>
<li><p>Se instalará <strong>multipary</strong> para trabajar con archivos y formularios: <code class="docutils literal notranslate"><span class="pre">npm</span> <span class="pre">install</span> <span class="pre">connect-multiparty</span> <span class="pre">--save</span></code></p></li>
</ul>
</section>
<section id="paso-2-editar-modelo-usuarios">
<h3><a class="toc-backref" href="#id55">Paso 2: Editar modelo usuarios</a><a class="headerlink" href="#paso-2-editar-modelo-usuarios" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Se va a añadir un nuevo campo al modelo de usuarios llamado <strong>avatar</strong>, editamos <strong>userModel.js</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">mongoose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongoose&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">Schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">;</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">UserSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Schema</span><span class="p">({</span><span class="w"></span>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">require</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="nx">lastname</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">require</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">require</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">unique</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="nx">password</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">require</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="nx">avatar</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// el avatar será de tipo string ya que solo guardamos el nombre del archivo</span><span class="w"></span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nx">require</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">});</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">UserSchema</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="paso-3-recuperar-usuario-y-actualizar-imagen-de-usuario-controller">
<h3><a class="toc-backref" href="#id56">Paso 3: Recuperar usuario y actualizar imagen de usuario (controller)</a><a class="headerlink" href="#paso-3-recuperar-usuario-y-actualizar-imagen-de-usuario-controller" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Para la lógica de esta aplicación, el usuario cambia su imagen solo después de registrarse. Así que haremos una función esclusiva para este fin. Editamos <strong>userController.js</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="kd">const</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;bcryptjs&#39;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">  2</span><span class="kd">const</span><span class="w"> </span><span class="nx">nodemailer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;nodemailer&#39;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">  3</span><span class="kd">const</span><span class="w"> </span><span class="nx">moment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;moment&#39;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">  4</span><span class="c1">// importar path:</span><span class="w"></span>
<span class="linenos">  5</span><span class="kd">const</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">  6</span><span class="kd">const</span><span class="w"> </span><span class="nx">User</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/userModel&#39;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">  7</span><span class="kd">const</span><span class="w"> </span><span class="nx">jwt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../services/jwtService&#39;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">  8</span><span class="c1">// importar auth middleware:</span><span class="w"></span>
<span class="linenos">  9</span><span class="kd">const</span><span class="w"> </span><span class="nx">authMiddleware</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../middlewares/authMiddleware&#39;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 10</span>
<span class="linenos"> 11</span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">postUser</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="linenos"> 12</span><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 13</span><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">User</span><span class="p">(</span><span class="nx">params</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 14</span>
<span class="linenos"> 15</span><span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 16</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">params</span><span class="p">.</span><span class="nx">email</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="p">{</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: email cannot be null&quot;</span><span class="p">};</span><span class="w"></span>
<span class="linenos"> 17</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">params</span><span class="p">.</span><span class="nx">password</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="p">{</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: password cannot be null&quot;</span><span class="p">};</span><span class="w"></span>
<span class="linenos"> 18</span>
<span class="linenos"> 19</span><span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">emailExists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">email</span><span class="p">});</span><span class="w"></span>
<span class="linenos"> 20</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="nx">emailExists</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="p">{</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: Email already exists&quot;</span><span class="p">};</span><span class="w"></span>
<span class="linenos"> 21</span>
<span class="linenos"> 22</span><span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">salt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">genSaltSync</span><span class="p">(</span><span class="mf">10</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 23</span><span class="w">        </span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span><span class="w"> </span><span class="nx">salt</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 24</span>
<span class="linenos"> 25</span><span class="w">        </span><span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span><span class="w"></span>
<span class="linenos"> 26</span><span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">});</span><span class="w"></span>
<span class="linenos"> 27</span>
<span class="linenos"> 28</span><span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="linenos"> 29</span><span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 30</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 31</span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 32</span>
<span class="linenos"> 33</span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">login</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="linenos"> 34</span><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="nx">email</span><span class="p">,</span><span class="w"> </span><span class="nx">password</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 35</span>
<span class="linenos"> 36</span><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 37</span><span class="w">        </span><span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="nx">email</span><span class="p">},</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">userData</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;{</span><span class="w"></span>
<span class="linenos"> 38</span><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="linenos"> 39</span><span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="linenos"> 40</span><span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 41</span><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">userData</span><span class="p">){</span><span class="w"></span>
<span class="linenos"> 42</span><span class="w">                    </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: email doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="linenos"> 43</span><span class="w">                </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 44</span><span class="w">                    </span><span class="kd">const</span><span class="w"> </span><span class="nx">passwordCorrect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span><span class="w"> </span><span class="nx">userData</span><span class="p">.</span><span class="nx">password</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 45</span><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">passwordCorrect</span><span class="p">){</span><span class="w"></span>
<span class="linenos"> 46</span><span class="w">                        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">403</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: incorrect password&quot;</span><span class="p">});</span><span class="w"></span>
<span class="linenos"> 47</span><span class="w">                    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 48</span><span class="w">                        </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">jwt</span><span class="p">.</span><span class="nx">createToken</span><span class="p">(</span><span class="nx">userData</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;24h&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 49</span>
<span class="linenos"> 50</span><span class="w">                        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">token</span><span class="o">:</span><span class="w"> </span><span class="nx">token</span><span class="p">});</span><span class="w"></span>
<span class="linenos"> 51</span><span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 52</span>
<span class="linenos"> 53</span><span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 54</span><span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 55</span><span class="w">        </span><span class="p">});</span><span class="w"></span>
<span class="linenos"> 56</span>
<span class="linenos"> 57</span><span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="linenos"> 58</span><span class="w">        </span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 59</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 60</span>
<span class="linenos"> 61</span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 62</span>
<span class="linenos"> 63</span><span class="kd">function</span><span class="w"> </span><span class="nx">forgot</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="linenos"> 64</span><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">email</span><span class="p">;</span><span class="w"></span>
<span class="linenos"> 65</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">email</span><span class="p">)</span><span class="k">throw</span><span class="p">{</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: email cannot be null&quot;</span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 66</span>
<span class="linenos"> 67</span><span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 68</span><span class="w">        </span><span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="nx">email</span><span class="p">},</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">userData</span><span class="p">)=&gt;{</span><span class="w"></span>
<span class="linenos"> 69</span><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="linenos"> 70</span><span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: email doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="linenos"> 71</span><span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 72</span><span class="w">                </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">jwt</span><span class="p">.</span><span class="nx">createToken</span><span class="p">(</span><span class="nx">userData</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;1h&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 73</span>
<span class="linenos"> 74</span><span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">transporter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nodemailer</span><span class="p">.</span><span class="nx">createTransport</span><span class="p">({</span><span class="w"></span>
<span class="linenos"> 75</span><span class="w">                    </span><span class="nx">host</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">EMAIL_HOST</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 76</span><span class="w">                    </span><span class="nx">port</span><span class="o">:</span><span class="w"> </span><span class="mf">2525</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 77</span><span class="w">                    </span><span class="nx">auth</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 78</span><span class="w">                        </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">EMAIL_USER</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 79</span><span class="w">                        </span><span class="nx">pass</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">EMAIL_PASS</span><span class="w"></span>
<span class="linenos"> 80</span><span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 81</span><span class="w">                </span><span class="p">});</span><span class="w"></span>
<span class="linenos"> 82</span>
<span class="linenos"> 83</span>
<span class="linenos"> 84</span><span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">mailOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 85</span><span class="w">                    </span><span class="kr">from</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pytonicus@gmail.com&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 86</span><span class="w">                    </span><span class="nx">to</span><span class="o">:</span><span class="w"> </span><span class="nx">userData</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 87</span><span class="w">                    </span><span class="nx">subject</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Reestablecer contraseña | Task Learn&#39;</span><span class="p">,</span><span class="w"></span>
<span class="linenos"> 88</span><span class="w">                    </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="sb">`http://localhost:3000/reset/</span><span class="si">${</span><span class="nx">userData</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">token</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="c1">// ruta del frontend</span><span class="w"></span>
<span class="linenos"> 89</span><span class="w">                </span><span class="p">};</span><span class="w"></span>
<span class="linenos"> 90</span>
<span class="linenos"> 91</span><span class="w">                </span><span class="nx">transporter</span><span class="p">.</span><span class="nx">sendMail</span><span class="p">(</span><span class="nx">mailOptions</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">response</span><span class="p">)=&gt;{</span><span class="w"></span>
<span class="linenos"> 92</span><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="linenos"> 93</span><span class="w">                        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="linenos"> 94</span><span class="w">                    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="linenos"> 95</span><span class="w">                        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Email has send&quot;</span><span class="p">});</span><span class="w"></span>
<span class="linenos"> 96</span><span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 97</span><span class="w">                </span><span class="p">});</span><span class="w"></span>
<span class="linenos"> 98</span><span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="linenos"> 99</span><span class="w">        </span><span class="p">});</span><span class="w"></span>
<span class="linenos">100</span><span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="linenos">101</span><span class="w">        </span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="linenos">102</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">103</span><span class="p">}</span><span class="w"></span>
<span class="linenos">104</span>
<span class="linenos">105</span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">resetPassword</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="linenos">106</span><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">token</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span><span class="w"></span>
<span class="linenos">107</span><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="nx">newPassword</span><span class="p">,</span><span class="w"> </span><span class="nx">repitePassword</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="w"></span>
<span class="linenos">108</span>
<span class="linenos">109</span><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user_token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">jwt</span><span class="p">.</span><span class="nx">decodeToken</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRET_KEY</span><span class="p">);</span><span class="w"></span>
<span class="linenos">110</span>
<span class="linenos">111</span>
<span class="linenos">112</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="nx">user_token</span><span class="p">.</span><span class="nx">exp</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">moment</span><span class="p">().</span><span class="nx">unix</span><span class="p">()){</span><span class="w"></span>
<span class="linenos">113</span><span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: token has expired&quot;</span><span class="p">});</span><span class="w"></span>
<span class="linenos">114</span><span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="nx">user_token</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">newPassword</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">repitePassword</span><span class="p">){</span><span class="w"></span>
<span class="linenos">115</span><span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">403</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: unauthorized request&quot;</span><span class="p">});</span><span class="w"></span>
<span class="linenos">116</span><span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="linenos">117</span><span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">salt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">genSaltSync</span><span class="p">(</span><span class="mf">10</span><span class="p">);</span><span class="w"></span>
<span class="linenos">118</span><span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">newPassword</span><span class="p">,</span><span class="w"> </span><span class="nx">salt</span><span class="p">);</span><span class="w"></span>
<span class="linenos">119</span><span class="w">        </span><span class="nx">User</span><span class="p">.</span><span class="nx">findByIdAndUpdate</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nx">password</span><span class="o">:</span><span class="w"> </span><span class="nx">password</span><span class="p">},</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;{</span><span class="w"></span>
<span class="linenos">120</span><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="linenos">121</span><span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="linenos">122</span><span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">){</span><span class="w"></span>
<span class="linenos">123</span><span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: user doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="linenos">124</span><span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="linenos">125</span><span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Password change successfully&quot;</span><span class="p">});</span><span class="w"></span>
<span class="linenos">126</span><span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="linenos">127</span><span class="w">        </span><span class="p">});</span><span class="w"></span>
<span class="linenos">128</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">129</span>
<span class="linenos">130</span><span class="p">}</span><span class="w"></span>
<span class="linenos">131</span>
<span class="linenos">132</span><span class="c1">// se va a crear una ruta para recuperar el usuario:</span><span class="w"></span>
<span class="linenos">133</span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getUser</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="linenos">134</span><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user_token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">authMiddleware</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">);</span><span class="w"></span>
<span class="linenos">135</span>
<span class="linenos">136</span><span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="linenos">137</span><span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">User</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">user_token</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span><span class="w"></span>
<span class="linenos">138</span>
<span class="linenos">139</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">){</span><span class="w"></span>
<span class="linenos">140</span><span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: user doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="linenos">141</span><span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">user_token</span><span class="p">.</span><span class="nx">id</span><span class="p">){</span><span class="w"></span>
<span class="linenos">142</span><span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">403</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Forbidden - Access to this resource on the server is denied!&quot;</span><span class="p">});</span><span class="w"></span>
<span class="linenos">143</span><span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="linenos">144</span><span class="w">            </span><span class="c1">// quitar password por seguridad:</span><span class="w"></span>
<span class="linenos">145</span><span class="w">            </span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="linenos">146</span><span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">});</span><span class="w"></span>
<span class="linenos">147</span><span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="linenos">148</span><span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="linenos">149</span><span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="linenos">150</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">151</span><span class="p">}</span><span class="w"></span>
<span class="linenos">152</span>
<span class="linenos">153</span><span class="c1">// se crea una función para subir avatar:</span><span class="w"></span>
<span class="linenos">154</span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">putUser</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="linenos">155</span><span class="w">    </span><span class="c1">// recuperar id:</span><span class="w"></span>
<span class="linenos">156</span><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span><span class="w"></span>
<span class="linenos">157</span><span class="w">    </span><span class="c1">// recuperar todos los parámetros:</span><span class="w"></span>
<span class="linenos">158</span><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="w"></span>
<span class="linenos">159</span>
<span class="linenos">160</span><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user_token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">authMiddleware</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">);</span><span class="w"></span>
<span class="linenos">161</span>
<span class="linenos">162</span><span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="linenos">163</span><span class="w">        </span><span class="c1">// se recupera el  usuario:</span><span class="w"></span>
<span class="linenos">164</span><span class="w">        </span><span class="nx">User</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">userData</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">165</span><span class="w">            </span><span class="c1">// si da error lanzamos un 500:</span><span class="w"></span>
<span class="linenos">166</span><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="linenos">167</span><span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="linenos">168</span><span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="linenos">169</span><span class="w">                </span><span class="c1">// si no tiene datos o no encuentra el usuario lanzamos 404:</span><span class="w"></span>
<span class="linenos">170</span><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">userData</span><span class="p">){</span><span class="w"></span>
<span class="linenos">171</span><span class="w">                    </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: user doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="linenos">172</span><span class="w">                </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="nx">user_token</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">userData</span><span class="p">.</span><span class="nx">_id</span><span class="p">){</span><span class="w"></span>
<span class="linenos">173</span><span class="w">                    </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">403</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: unauthorized request&quot;</span><span class="p">});</span><span class="w"></span>
<span class="linenos">174</span><span class="w">                </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="linenos">175</span><span class="w">                    </span><span class="c1">// añadir el salt para el password:</span><span class="w"></span>
<span class="linenos">176</span><span class="w">                    </span><span class="kd">const</span><span class="w"> </span><span class="nx">salt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">genSaltSync</span><span class="p">(</span><span class="mf">10</span><span class="p">);</span><span class="w"></span>
<span class="linenos">177</span><span class="w">                    </span><span class="c1">// actualizar la información por aquella recibida de parametros:</span><span class="w"></span>
<span class="linenos">178</span><span class="w">                    </span><span class="nx">userData</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span><span class="w"></span>
<span class="linenos">179</span><span class="w">                    </span><span class="nx">userData</span><span class="p">.</span><span class="nx">lastname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">lastname</span><span class="p">;</span><span class="w"></span>
<span class="linenos">180</span><span class="w">                    </span><span class="nx">userData</span><span class="p">.</span><span class="nx">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">email</span><span class="p">;</span><span class="w"></span>
<span class="linenos">181</span>
<span class="linenos">182</span><span class="w">                    </span><span class="c1">// verificar que nos llegue un password para que no quede en blanco este campo:</span><span class="w"></span>
<span class="linenos">183</span><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">password</span><span class="p">){</span><span class="w"></span>
<span class="linenos">184</span><span class="w">                        </span><span class="nx">userData</span><span class="p">.</span><span class="nx">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span><span class="w"> </span><span class="nx">salt</span><span class="p">);</span><span class="w"></span>
<span class="linenos">185</span><span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">186</span>
<span class="linenos">187</span><span class="w">                    </span><span class="c1">// si tenemos el campo avatar de tipo file seguimos adelante:</span><span class="w"></span>
<span class="linenos">188</span><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">files</span><span class="p">.</span><span class="nx">avatar</span><span class="p">){</span><span class="w"></span>
<span class="linenos">189</span><span class="w">                        </span><span class="c1">// obtener el path del fichero:</span><span class="w"></span>
<span class="linenos">190</span><span class="w">                        </span><span class="kd">const</span><span class="w"> </span><span class="nx">filePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">files</span><span class="p">.</span><span class="nx">avatar</span><span class="p">.</span><span class="nx">path</span><span class="p">;</span><span class="w"></span>
<span class="linenos">191</span><span class="w">                        </span><span class="c1">// separar el id del archivo de la ruta upload:</span><span class="w"></span>
<span class="linenos">192</span><span class="w">                        </span><span class="kd">let</span><span class="w"> </span><span class="nx">fileSplit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">filePath</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">sep</span><span class="p">);</span><span class="w"></span>
<span class="linenos">193</span><span class="w">                        </span><span class="c1">// sacamos el id unico del archivo para usarlo como nombre:</span><span class="w"></span>
<span class="linenos">194</span><span class="w">                        </span><span class="kd">let</span><span class="w"> </span><span class="nx">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fileSplit</span><span class="p">[</span><span class="nx">fileSplit</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mf">1</span><span class="p">];</span><span class="w"></span>
<span class="linenos">195</span>
<span class="linenos">196</span><span class="w">                        </span><span class="c1">// filtar el tipo de fichero a subir:</span><span class="w"></span>
<span class="linenos">197</span><span class="w">                        </span><span class="kd">let</span><span class="w"> </span><span class="nx">fileExt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">filename</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// separar la extensión</span><span class="w"></span>
<span class="linenos">198</span><span class="w">                        </span><span class="k">if</span><span class="p">(</span><span class="nx">fileExt</span><span class="p">[</span><span class="nx">fileExt</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s2">&quot;jpg&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">fileExt</span><span class="p">[</span><span class="nx">fileExt</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s2">&quot;jpeg&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">fileExt</span><span class="p">[</span><span class="nx">fileExt</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s2">&quot;png&quot;</span><span class="p">){</span><span class="w"></span>
<span class="linenos">199</span><span class="w">                            </span><span class="c1">// se borra el archivo recien subido al servidor si no cumple con la extensión:</span><span class="w"></span>
<span class="linenos">200</span><span class="w">                            </span><span class="nx">fs</span><span class="p">.</span><span class="nx">unlink</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)=&gt;{</span><span class="w"></span>
<span class="linenos">201</span><span class="w">                                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span><span class="w"></span>
<span class="linenos">202</span><span class="w">                                </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Only extension can be JPG or PNG&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos">203</span><span class="w">                            </span><span class="p">});</span><span class="w"></span>
<span class="linenos">204</span><span class="w">                        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="linenos">205</span><span class="w">                            </span><span class="c1">// comprobar si existe ya un avatar lo eliminamos:</span><span class="w"></span>
<span class="linenos">206</span><span class="w">                            </span><span class="k">if</span><span class="p">(</span><span class="nx">userData</span><span class="p">.</span><span class="nx">avatar</span><span class="p">){</span><span class="w"></span>
<span class="linenos">207</span><span class="w">                                </span><span class="kd">const</span><span class="w"> </span><span class="nx">old_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`./uploads/avatars/</span><span class="si">${</span><span class="nx">userData</span><span class="p">.</span><span class="nx">avatar</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span><span class="w"></span>
<span class="linenos">208</span><span class="w">                                </span><span class="nx">fs</span><span class="p">.</span><span class="nx">unlink</span><span class="p">(</span><span class="nx">old_path</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)=&gt;{</span><span class="w"></span>
<span class="linenos">209</span><span class="w">                                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span><span class="w"></span>
<span class="linenos">210</span><span class="w">                                </span><span class="p">});</span><span class="w"></span>
<span class="linenos">211</span><span class="w">                            </span><span class="p">}</span><span class="w"></span>
<span class="linenos">212</span><span class="w">                            </span><span class="c1">// le pasamos al objeto user el nombre del archivo:</span><span class="w"></span>
<span class="linenos">213</span><span class="w">                            </span><span class="nx">userData</span><span class="p">.</span><span class="nx">avatar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">filename</span><span class="p">;</span><span class="w"></span>
<span class="linenos">214</span><span class="w">                        </span><span class="p">}</span><span class="w"></span>
<span class="linenos">215</span><span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">216</span>
<span class="linenos">217</span><span class="w">                    </span><span class="c1">// actualizar el nombre del archivo en la base de datos:</span><span class="w"></span>
<span class="linenos">218</span><span class="w">                    </span><span class="nx">User</span><span class="p">.</span><span class="nx">findByIdAndUpdate</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span><span class="w"> </span><span class="nx">userData</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">219</span><span class="w">                        </span><span class="c1">// si hay errores un 500:</span><span class="w"></span>
<span class="linenos">220</span><span class="w">                        </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="linenos">221</span><span class="w">                            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="linenos">222</span><span class="w">                        </span><span class="c1">// verificar si no existe le usuario:</span><span class="w"></span>
<span class="linenos">223</span><span class="w">                        </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">){</span><span class="w"></span>
<span class="linenos">224</span><span class="w">                            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: user doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="linenos">225</span><span class="w">                        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="linenos">226</span><span class="w">                            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="nx">userData</span><span class="p">});</span><span class="w"></span>
<span class="linenos">227</span><span class="w">                        </span><span class="p">}</span><span class="w"></span>
<span class="linenos">228</span><span class="w">                    </span><span class="p">});</span><span class="w"></span>
<span class="linenos">229</span>
<span class="linenos">230</span><span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="linenos">231</span><span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="linenos">232</span><span class="w">        </span><span class="p">});</span><span class="w"></span>
<span class="linenos">233</span><span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="linenos">234</span><span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="linenos">235</span><span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="linenos">236</span><span class="p">}</span><span class="w"></span>
<span class="linenos">237</span>
<span class="linenos">238</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="linenos">239</span><span class="w">    </span><span class="nx">postUser</span><span class="p">,</span><span class="w"></span>
<span class="linenos">240</span><span class="w">    </span><span class="nx">login</span><span class="p">,</span><span class="w"></span>
<span class="linenos">241</span><span class="w">    </span><span class="nx">forgot</span><span class="p">,</span><span class="w"></span>
<span class="linenos">242</span><span class="w">    </span><span class="nx">resetPassword</span><span class="p">,</span><span class="w"></span>
<span class="linenos">243</span><span class="w">    </span><span class="nx">getUser</span><span class="p">,</span><span class="w"> </span><span class="c1">// exportar modulo</span><span class="w"></span>
<span class="linenos">244</span><span class="w">    </span><span class="nx">putUser</span><span class="w">  </span><span class="c1">// exportar modulo</span><span class="w"></span>
<span class="linenos">245</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="paso-4-recuperar-usuario-y-actualizar-imagen-de-usuario-router">
<h3><a class="toc-backref" href="#id57">Paso 4: Recuperar usuario y actualizar imagen de usuario (router)</a><a class="headerlink" href="#paso-4-recuperar-usuario-y-actualizar-imagen-de-usuario-router" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Añadir la nueva ruta a <strong>userRoutes.js</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;express&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 2</span><span class="c1">// importar multiparty:</span><span class="w"></span>
<span class="linenos"> 3</span><span class="kd">const</span><span class="w"> </span><span class="nx">multiparty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;connect-multiparty&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 4</span><span class="kd">const</span><span class="w"> </span><span class="nx">userController</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../controllers/userController&#39;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 5</span><span class="c1">// cargar auth middleware:</span><span class="w"></span>
<span class="linenos"> 6</span><span class="kd">const</span><span class="w"> </span><span class="nx">authMiddleware</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../middlewares/authMiddleware&#39;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 7</span><span class="c1">// crear middleware con multipary:</span><span class="w"></span>
<span class="linenos"> 8</span><span class="kd">const</span><span class="w"> </span><span class="nx">uploadAvatarMiddleware</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">multiparty</span><span class="p">({</span><span class="nx">uploadDir</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;./uploads/avatars&#39;</span><span class="p">});</span><span class="w"></span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="kd">const</span><span class="w"> </span><span class="nx">api</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span><span class="w"></span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="nx">api</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/register&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">userController</span><span class="p">.</span><span class="nx">postUser</span><span class="p">);</span><span class="w"></span>
<span class="linenos">13</span><span class="nx">api</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/login&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">userController</span><span class="p">.</span><span class="nx">login</span><span class="p">);</span><span class="w"></span>
<span class="linenos">14</span><span class="nx">api</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/forgot&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">userController</span><span class="p">.</span><span class="nx">forgot</span><span class="p">);</span><span class="w"></span>
<span class="linenos">15</span><span class="nx">api</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s2">&quot;/reset/:id/:token&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">userController</span><span class="p">.</span><span class="nx">resetPassword</span><span class="p">);</span><span class="w"></span>
<span class="linenos">16</span><span class="c1">// cargar ruta para mostrar usuario:</span><span class="w"></span>
<span class="linenos">17</span><span class="nx">api</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/users&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">authMiddleware</span><span class="p">.</span><span class="nx">secureRoute</span><span class="p">],</span><span class="w"> </span><span class="nx">userController</span><span class="p">.</span><span class="nx">getUser</span><span class="p">);</span><span class="w"></span>
<span class="linenos">18</span><span class="c1">// añadimos la ruta que se utilizará para subir el avatar (el token primero ya que respeta orden):</span><span class="w"></span>
<span class="linenos">19</span><span class="nx">api</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s2">&quot;/users/:id&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">authMiddleware</span><span class="p">.</span><span class="nx">secureRoute</span><span class="p">,</span><span class="w"> </span><span class="nx">uploadAvatarMiddleware</span><span class="p">],</span><span class="w"> </span><span class="nx">userController</span><span class="p">.</span><span class="nx">putUser</span><span class="p">);</span><span class="w"></span>
<span class="linenos">20</span>
<span class="linenos">21</span>
<span class="linenos">22</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">api</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>Crear carpeta <strong>uploads</strong> y dentro de ella <strong>avatars</strong>.</p></li>
<li><p>añadir la línea <strong>uploads/</strong> al archivo <strong>.gitignore</strong>.</p></li>
<li><p>Crear dentro de cada carpeta de las anteriores un archivo llamado <strong>.gitkeep</strong></p></li>
</ul>
<div class="admonition important">
<p class="admonition-title">Importante</p>
<p>Debes crear las carpetas anteriores o multiparty dará error.</p>
</div>
<ul class="simple">
<li><p>Ahora se crean dos request en postman, una tipo GET para recuperar el usuario y una tipo PUT para actualizarlo.</p></li>
<li><p>A partir de ahora usaremos en <strong>Body</strong> la opción <strong>form-data</strong> para enviar cada uno de los campos. Para el campo <strong>avatar</strong> podemos pinchar a la derecha de la misma celda en <strong>text</strong> y cambiarlo por <strong>file</strong> para poder cargar un archivo.</p></li>
</ul>
</section>
<section id="paso-5-recuperar-avatar-controller">
<h3><a class="toc-backref" href="#id58">paso 5: Recuperar avatar (controller)</a><a class="headerlink" href="#paso-5-recuperar-avatar-controller" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Ahora vamos a recuperar una imagen guardada en el servidor. Editamos <strong>userController.js</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;bcryptjs&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">nodemailer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;nodemailer&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">moment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;moment&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span><span class="w"></span>
<span class="c1">// importar la api interna filesystem:</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">User</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/userModel&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">jwt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../services/jwtService&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">authMiddleware</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../middlewares/authMiddleware&#39;</span><span class="p">);</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">postUser</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">User</span><span class="p">(</span><span class="nx">params</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">params</span><span class="p">.</span><span class="nx">email</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="p">{</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: email cannot be null&quot;</span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">params</span><span class="p">.</span><span class="nx">password</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="p">{</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: password cannot be null&quot;</span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">emailExists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">email</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="nx">emailExists</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="p">{</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: Email already exists&quot;</span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">salt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">genSaltSync</span><span class="p">(</span><span class="mf">10</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span><span class="w"> </span><span class="nx">salt</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">login</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="nx">email</span><span class="p">,</span><span class="w"> </span><span class="nx">password</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="nx">email</span><span class="p">},</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">userData</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">userData</span><span class="p">){</span><span class="w"></span>
<span class="w">                    </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: email doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="kd">const</span><span class="w"> </span><span class="nx">passwordCorrect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span><span class="w"> </span><span class="nx">userData</span><span class="p">.</span><span class="nx">password</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">passwordCorrect</span><span class="p">){</span><span class="w"></span>
<span class="w">                        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">403</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: incorrect password&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">jwt</span><span class="p">.</span><span class="nx">createToken</span><span class="p">(</span><span class="nx">userData</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;24h&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">                        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">token</span><span class="o">:</span><span class="w"> </span><span class="nx">token</span><span class="p">});</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>

<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>

<span class="kd">function</span><span class="w"> </span><span class="nx">forgot</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">email</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">email</span><span class="p">)</span><span class="k">throw</span><span class="p">{</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: email cannot be null&quot;</span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="nx">email</span><span class="p">},</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">userData</span><span class="p">)=&gt;{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: email doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">jwt</span><span class="p">.</span><span class="nx">createToken</span><span class="p">(</span><span class="nx">userData</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;1h&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">transporter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nodemailer</span><span class="p">.</span><span class="nx">createTransport</span><span class="p">({</span><span class="w"></span>
<span class="w">                    </span><span class="nx">host</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">EMAIL_HOST</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="nx">port</span><span class="o">:</span><span class="w"> </span><span class="mf">2525</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="nx">auth</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">EMAIL_USER</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="nx">pass</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">EMAIL_PASS</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">});</span><span class="w"></span>


<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">mailOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="kr">from</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pytonicus@gmail.com&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="nx">to</span><span class="o">:</span><span class="w"> </span><span class="nx">userData</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="nx">subject</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Reestablecer contraseña | Task Learn&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="sb">`http://localhost:3000/reset/</span><span class="si">${</span><span class="nx">userData</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">token</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="c1">// ruta del frontend</span><span class="w"></span>
<span class="w">                </span><span class="p">};</span><span class="w"></span>

<span class="w">                </span><span class="nx">transporter</span><span class="p">.</span><span class="nx">sendMail</span><span class="p">(</span><span class="nx">mailOptions</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">response</span><span class="p">)=&gt;{</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Email has send&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">resetPassword</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">token</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="nx">newPassword</span><span class="p">,</span><span class="w"> </span><span class="nx">repitePassword</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user_token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">jwt</span><span class="p">.</span><span class="nx">decodeToken</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRET_KEY</span><span class="p">);</span><span class="w"></span>


<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="nx">user_token</span><span class="p">.</span><span class="nx">exp</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">moment</span><span class="p">().</span><span class="nx">unix</span><span class="p">()){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: token has expired&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="nx">user_token</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">newPassword</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">repitePassword</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">403</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: unauthorized request&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">salt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">genSaltSync</span><span class="p">(</span><span class="mf">10</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">newPassword</span><span class="p">,</span><span class="w"> </span><span class="nx">salt</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="nx">User</span><span class="p">.</span><span class="nx">findByIdAndUpdate</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nx">password</span><span class="o">:</span><span class="w"> </span><span class="nx">password</span><span class="p">},</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: user doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Password change successfully&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getUser</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user_token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">authMiddleware</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">User</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">user_token</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: user doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">user_token</span><span class="p">.</span><span class="nx">id</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">403</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Forbidden - Access to this resource on the server is denied!&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">putUser</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user_token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">authMiddleware</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">User</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">userData</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">userData</span><span class="p">){</span><span class="w"></span>
<span class="w">                    </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: user doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="nx">user_token</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">userData</span><span class="p">.</span><span class="nx">id</span><span class="p">){</span><span class="w"></span>
<span class="w">                    </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">403</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: unauthorized request&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="kd">const</span><span class="w"> </span><span class="nx">salt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">genSaltSync</span><span class="p">(</span><span class="mf">10</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="nx">userData</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="nx">userData</span><span class="p">.</span><span class="nx">lastname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">lastname</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="nx">userData</span><span class="p">.</span><span class="nx">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">email</span><span class="p">;</span><span class="w"></span>

<span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">password</span><span class="p">){</span><span class="w"></span>
<span class="w">                        </span><span class="nx">userData</span><span class="p">.</span><span class="nx">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span><span class="w"> </span><span class="nx">salt</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>

<span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">files</span><span class="p">.</span><span class="nx">avatar</span><span class="p">){</span><span class="w"></span>
<span class="w">                        </span><span class="kd">const</span><span class="w"> </span><span class="nx">filePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">files</span><span class="p">.</span><span class="nx">avatar</span><span class="p">.</span><span class="nx">path</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="kd">let</span><span class="w"> </span><span class="nx">fileSplit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">filePath</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">sep</span><span class="p">);</span><span class="w"></span>
<span class="w">                        </span><span class="kd">let</span><span class="w"> </span><span class="nx">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fileSplit</span><span class="p">[</span><span class="nx">fileSplit</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mf">1</span><span class="p">];</span><span class="w"></span>

<span class="w">                        </span><span class="kd">let</span><span class="w"> </span><span class="nx">fileExt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">filename</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">                        </span><span class="k">if</span><span class="p">(</span><span class="nx">fileExt</span><span class="p">[</span><span class="nx">fileExt</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s2">&quot;jpg&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">fileExt</span><span class="p">[</span><span class="nx">fileExt</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s2">&quot;jpeg&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">fileExt</span><span class="p">[</span><span class="nx">fileExt</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s2">&quot;png&quot;</span><span class="p">){</span><span class="w"></span>
<span class="w">                            </span><span class="nx">fs</span><span class="p">.</span><span class="nx">unlink</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)=&gt;{</span><span class="w"></span>
<span class="w">                                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span><span class="w"></span>
<span class="w">                                </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Only extension can be JPG or PNG&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">                            </span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                            </span><span class="k">if</span><span class="p">(</span><span class="nx">userData</span><span class="p">.</span><span class="nx">avatar</span><span class="p">){</span><span class="w"></span>
<span class="w">                                </span><span class="kd">const</span><span class="w"> </span><span class="nx">old_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`./uploads/avatars/</span><span class="si">${</span><span class="nx">userData</span><span class="p">.</span><span class="nx">avatar</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span><span class="w"></span>
<span class="w">                                </span><span class="nx">fs</span><span class="p">.</span><span class="nx">unlink</span><span class="p">(</span><span class="nx">old_path</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)=&gt;{</span><span class="w"></span>
<span class="w">                                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span><span class="w"></span>
<span class="w">                                </span><span class="p">});</span><span class="w"></span>
<span class="w">                            </span><span class="p">}</span><span class="w"></span>
<span class="w">                            </span><span class="nx">userData</span><span class="p">.</span><span class="nx">avatar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">filename</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>

<span class="w">                    </span><span class="nx">User</span><span class="p">.</span><span class="nx">findByIdAndUpdate</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span><span class="w"> </span><span class="nx">userData</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">){</span><span class="w"></span>
<span class="w">                            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: user doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="nx">userData</span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="p">});</span><span class="w"></span>

<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// crear función para leer archivo:</span><span class="w"></span>
<span class="kd">function</span><span class="w"> </span><span class="nx">getAvatar</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="c1">// recuperar el nombre del avatar:</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">avatarName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">avatarName</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// se prepara la ruta del archivo:</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">filePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`./uploads/avatars/</span><span class="si">${</span><span class="nx">avatarName</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// comprobar que existe el fichero:</span><span class="w"></span>
<span class="w">    </span><span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">stat</span><span class="p">)=&gt;{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// si no existe 404:</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: Avatar doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// si existe lo recuperamos:</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">sendFile</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">filePath</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">postUser</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">login</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">forgot</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">resetPassword</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">getUser</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">putUser</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">getAvatar</span><span class="w"> </span><span class="c1">// exportar modulo</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="paso-6-recuperar-avatar-router">
<h3><a class="toc-backref" href="#id59">paso 6: Recuperar avatar (router)</a><a class="headerlink" href="#paso-6-recuperar-avatar-router" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Ahora vamos a crear el endpoint para recuperar el avatar en <strong>userRoutes.js</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;express&quot;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">multiparty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;connect-multiparty&quot;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">userController</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../controllers/userController&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">authMiddleware</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../middlewares/authMiddleware&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">uploadAvatarMiddleware</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">multiparty</span><span class="p">({</span><span class="nx">uploadDir</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;./uploads/avatars&#39;</span><span class="p">});</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">api</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span><span class="w"></span>

<span class="nx">api</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/register&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">userController</span><span class="p">.</span><span class="nx">postUser</span><span class="p">);</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/login&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">userController</span><span class="p">.</span><span class="nx">login</span><span class="p">);</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/forgot&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">userController</span><span class="p">.</span><span class="nx">forgot</span><span class="p">);</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s2">&quot;/reset/:id/:token&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">userController</span><span class="p">.</span><span class="nx">resetPassword</span><span class="p">);</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/users&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">authMiddleware</span><span class="p">.</span><span class="nx">secureRoute</span><span class="p">],</span><span class="w"> </span><span class="nx">userController</span><span class="p">.</span><span class="nx">getUser</span><span class="p">);</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s2">&quot;/users/:id&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">authMiddleware</span><span class="p">.</span><span class="nx">secureRoute</span><span class="p">,</span><span class="w"> </span><span class="nx">uploadAvatarMiddleware</span><span class="p">],</span><span class="w"> </span><span class="nx">userController</span><span class="p">.</span><span class="nx">putUser</span><span class="p">);</span><span class="w"></span>
<span class="c1">// recuperar avatar a traves de esta ruta:</span><span class="w"></span>
<span class="nx">api</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/users/avatar/:avatarName&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">userController</span><span class="p">.</span><span class="nx">getAvatar</span><span class="p">);</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">api</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="paso-7-eliminar-usuario-controller">
<h3><a class="toc-backref" href="#id60">Paso 7: Eliminar usuario (controller)</a><a class="headerlink" href="#paso-7-eliminar-usuario-controller" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Vamos a crear una función para eliminar usuarios llamada <strong>deleteUser</strong> en <strong>userController.js</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;bcryptjs&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">nodemailer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;nodemailer&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">moment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;moment&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span><span class="w"></span>

<span class="c1">// importar modelo tareas:</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">Task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/taskModel&#39;</span><span class="p">);</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">User</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/userModel&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">jwt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../services/jwtService&#39;</span><span class="p">);</span><span class="w"></span>
<span class="kd">const</span><span class="w"> </span><span class="nx">authMiddleware</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../middlewares/authMiddleware&#39;</span><span class="p">);</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">postUser</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">User</span><span class="p">(</span><span class="nx">params</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">params</span><span class="p">.</span><span class="nx">email</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="p">{</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: email cannot be null&quot;</span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">params</span><span class="p">.</span><span class="nx">password</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="p">{</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: password cannot be null&quot;</span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">emailExists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">email</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="nx">emailExists</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="p">{</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: Email already exists&quot;</span><span class="p">};</span><span class="w"></span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">salt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">genSaltSync</span><span class="p">(</span><span class="mf">10</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span><span class="w"> </span><span class="nx">salt</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">login</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="nx">email</span><span class="p">,</span><span class="w"> </span><span class="nx">password</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="nx">email</span><span class="p">},</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">userData</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">userData</span><span class="p">){</span><span class="w"></span>
<span class="w">                    </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: email doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="kd">const</span><span class="w"> </span><span class="nx">passwordCorrect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span><span class="w"> </span><span class="nx">userData</span><span class="p">.</span><span class="nx">password</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">passwordCorrect</span><span class="p">){</span><span class="w"></span>
<span class="w">                        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">403</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: incorrect password&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">jwt</span><span class="p">.</span><span class="nx">createToken</span><span class="p">(</span><span class="nx">userData</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;24h&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">                        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">token</span><span class="o">:</span><span class="w"> </span><span class="nx">token</span><span class="p">});</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>

<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>

<span class="kd">function</span><span class="w"> </span><span class="nx">forgot</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">email</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">email</span><span class="p">)</span><span class="k">throw</span><span class="p">{</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: email cannot be null&quot;</span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="nx">email</span><span class="p">},</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">userData</span><span class="p">)=&gt;{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: email doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">jwt</span><span class="p">.</span><span class="nx">createToken</span><span class="p">(</span><span class="nx">userData</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;1h&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">transporter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nodemailer</span><span class="p">.</span><span class="nx">createTransport</span><span class="p">({</span><span class="w"></span>
<span class="w">                    </span><span class="nx">host</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">EMAIL_HOST</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="nx">port</span><span class="o">:</span><span class="w"> </span><span class="mf">2525</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="nx">auth</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">EMAIL_USER</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="nx">pass</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">EMAIL_PASS</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">});</span><span class="w"></span>


<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">mailOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="kr">from</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pytonicus@gmail.com&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="nx">to</span><span class="o">:</span><span class="w"> </span><span class="nx">userData</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="nx">subject</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Reestablecer contraseña | Task Learn&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="sb">`http://localhost:3000/reset/</span><span class="si">${</span><span class="nx">userData</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">token</span><span class="si">}</span><span class="sb">`</span><span class="w"> </span><span class="c1">// ruta del frontend</span><span class="w"></span>
<span class="w">                </span><span class="p">};</span><span class="w"></span>

<span class="w">                </span><span class="nx">transporter</span><span class="p">.</span><span class="nx">sendMail</span><span class="p">(</span><span class="nx">mailOptions</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">response</span><span class="p">)=&gt;{</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Email has send&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">resetPassword</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">token</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="nx">newPassword</span><span class="p">,</span><span class="w"> </span><span class="nx">repitePassword</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user_token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">jwt</span><span class="p">.</span><span class="nx">decodeToken</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRET_KEY</span><span class="p">);</span><span class="w"></span>


<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="nx">user_token</span><span class="p">.</span><span class="nx">exp</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">moment</span><span class="p">().</span><span class="nx">unix</span><span class="p">()){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: token has expired&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="nx">user_token</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">newPassword</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">repitePassword</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">403</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: unauthorized request&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">salt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">genSaltSync</span><span class="p">(</span><span class="mf">10</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">newPassword</span><span class="p">,</span><span class="w"> </span><span class="nx">salt</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="nx">User</span><span class="p">.</span><span class="nx">findByIdAndUpdate</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nx">password</span><span class="o">:</span><span class="w"> </span><span class="nx">password</span><span class="p">},</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: user doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Password change successfully&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getUser</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user_token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">authMiddleware</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">User</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">user_token</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: user doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">user_token</span><span class="p">.</span><span class="nx">id</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">403</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Forbidden - Access to this resource on the server is denied!&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">putUser</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user_token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">authMiddleware</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nx">User</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">userData</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">userData</span><span class="p">){</span><span class="w"></span>
<span class="w">                    </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: user doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="nx">user_token</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">userData</span><span class="p">.</span><span class="nx">id</span><span class="p">){</span><span class="w"></span>
<span class="w">                    </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">403</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: unauthorized request&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="kd">const</span><span class="w"> </span><span class="nx">salt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">genSaltSync</span><span class="p">(</span><span class="mf">10</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="nx">userData</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="nx">userData</span><span class="p">.</span><span class="nx">lastname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">lastname</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="nx">userData</span><span class="p">.</span><span class="nx">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">email</span><span class="p">;</span><span class="w"></span>

<span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">password</span><span class="p">){</span><span class="w"></span>
<span class="w">                        </span><span class="nx">userData</span><span class="p">.</span><span class="nx">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">bcryptjs</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span><span class="w"> </span><span class="nx">salt</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>

<span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">files</span><span class="p">.</span><span class="nx">avatar</span><span class="p">){</span><span class="w"></span>
<span class="w">                        </span><span class="kd">const</span><span class="w"> </span><span class="nx">filePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">files</span><span class="p">.</span><span class="nx">avatar</span><span class="p">.</span><span class="nx">path</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="kd">let</span><span class="w"> </span><span class="nx">fileSplit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">filePath</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">sep</span><span class="p">);</span><span class="w"></span>
<span class="w">                        </span><span class="kd">let</span><span class="w"> </span><span class="nx">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fileSplit</span><span class="p">[</span><span class="nx">fileSplit</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mf">1</span><span class="p">];</span><span class="w"></span>

<span class="w">                        </span><span class="kd">let</span><span class="w"> </span><span class="nx">fileExt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">filename</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">                        </span><span class="k">if</span><span class="p">(</span><span class="nx">fileExt</span><span class="p">[</span><span class="nx">fileExt</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s2">&quot;jpg&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">fileExt</span><span class="p">[</span><span class="nx">fileExt</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s2">&quot;jpeg&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">fileExt</span><span class="p">[</span><span class="nx">fileExt</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s2">&quot;png&quot;</span><span class="p">){</span><span class="w"></span>
<span class="w">                            </span><span class="nx">fs</span><span class="p">.</span><span class="nx">unlink</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)=&gt;{</span><span class="w"></span>
<span class="w">                                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span><span class="w"></span>
<span class="w">                                </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Only extension can be JPG or PNG&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">                            </span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                            </span><span class="k">if</span><span class="p">(</span><span class="nx">userData</span><span class="p">.</span><span class="nx">avatar</span><span class="p">){</span><span class="w"></span>
<span class="w">                                </span><span class="kd">const</span><span class="w"> </span><span class="nx">old_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`./uploads/avatars/</span><span class="si">${</span><span class="nx">userData</span><span class="p">.</span><span class="nx">avatar</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span><span class="w"></span>
<span class="w">                                </span><span class="nx">fs</span><span class="p">.</span><span class="nx">unlink</span><span class="p">(</span><span class="nx">old_path</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)=&gt;{</span><span class="w"></span>
<span class="w">                                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span><span class="w"></span>
<span class="w">                                </span><span class="p">});</span><span class="w"></span>
<span class="w">                            </span><span class="p">}</span><span class="w"></span>
<span class="w">                            </span><span class="nx">userData</span><span class="p">.</span><span class="nx">avatar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">filename</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>

<span class="w">                    </span><span class="nx">User</span><span class="p">.</span><span class="nx">findByIdAndUpdate</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span><span class="w"> </span><span class="nx">userData</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                            </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">){</span><span class="w"></span>
<span class="w">                                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: user doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                            </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">){</span><span class="w"></span>
<span class="w">                                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: user doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                            </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">201</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="nx">userData</span><span class="p">});</span><span class="w"></span>
<span class="w">                            </span><span class="p">}</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"></span>
<span class="w">                    </span><span class="p">});</span><span class="w"></span>

<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">function</span><span class="w"> </span><span class="nx">getAvatar</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">avatarName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">avatarName</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">filePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`./uploads/avatars/</span><span class="si">${</span><span class="nx">avatarName</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">stat</span><span class="p">)=&gt;{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: Avatar doesn&#39;t exists&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nx">res</span><span class="p">.</span><span class="nx">sendFile</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">filePath</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// crear función para eliminar usuarios:</span><span class="w"></span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">deleteUser</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="c1">// coger el parametro id:</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">user_token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">authMiddleware</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// recuperar usuario a eliminar:</span><span class="w"></span>
<span class="w">        </span><span class="nx">User</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">userData</span><span class="p">)=&gt;{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="nx">user_token</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">userData</span><span class="p">.</span><span class="nx">id</span><span class="p">){</span><span class="w"></span>
<span class="w">                </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">403</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: unauthorized request&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// evitar errores al cargar nombre de avatar:</span><span class="w"></span>
<span class="w">                </span><span class="k">try</span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="kd">var</span><span class="w"> </span><span class="nx">avatar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">userData</span><span class="p">.</span><span class="nx">avatar</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="k">catch</span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="kd">var</span><span class="w"> </span><span class="nx">avatar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>

<span class="w">                </span><span class="nx">User</span><span class="p">.</span><span class="nx">findByIdAndDelete</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)=&gt;{</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">){</span><span class="w"></span>
<span class="w">                        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Error: User doesn&#39;t exist&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="c1">// si existe un avatar lo eliminamos:</span><span class="w"></span>
<span class="w">                        </span><span class="k">if</span><span class="p">(</span><span class="nx">avatar</span><span class="p">){</span><span class="w"></span>
<span class="w">                            </span><span class="kd">const</span><span class="w"> </span><span class="nx">old_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`./uploads/avatars/</span><span class="si">${</span><span class="nx">avatar</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span><span class="w"></span>
<span class="w">                            </span><span class="nx">fs</span><span class="p">.</span><span class="nx">unlink</span><span class="p">(</span><span class="nx">old_path</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)=&gt;{</span><span class="w"></span>
<span class="w">                                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span><span class="w"></span>
<span class="w">                            </span><span class="p">});</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"></span>

<span class="w">                        </span><span class="c1">// recorrer tareas e ir borrandolas:</span><span class="w"></span>
<span class="w">                        </span><span class="nx">Task</span><span class="p">.</span><span class="nx">deleteMany</span><span class="p">({</span><span class="nx">owner</span><span class="o">:</span><span class="w"> </span><span class="nx">userId</span><span class="p">},</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">taskData</span><span class="p">)=&gt;{</span><span class="w"></span>
<span class="w">                            </span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="w"></span>
<span class="w">                                </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Server status error&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">                            </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">taskData</span><span class="p">){</span><span class="w"></span>
<span class="w">                                </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;No tasks to remove&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">                            </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"></span>
<span class="w">                                </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;tasks has removed&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">                            </span><span class="p">}</span><span class="w"></span>
<span class="w">                        </span><span class="p">});</span><span class="w"></span>

<span class="w">                        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;User delete successfully&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="p">});</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Server status error&quot;</span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">postUser</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">login</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">forgot</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">resetPassword</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">getUser</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">putUser</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">getAvatar</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nx">deleteUser</span><span class="w"> </span><span class="c1">// exportar modulo</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="paso-8-eliminar-usuario-router">
<h3><a class="toc-backref" href="#id61">Paso 8: Eliminar usuario (router)</a><a class="headerlink" href="#paso-8-eliminar-usuario-router" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Ahora vamos a cargar la ruta para eliminar el usuario en <strong>userRoutes.js</strong>:</p></li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;express&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 2</span><span class="kd">const</span><span class="w"> </span><span class="nx">multiparty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;connect-multiparty&quot;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 3</span><span class="kd">const</span><span class="w"> </span><span class="nx">userController</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../controllers/userController&#39;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 4</span><span class="kd">const</span><span class="w"> </span><span class="nx">authMiddleware</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../middlewares/authMiddleware&#39;</span><span class="p">);</span><span class="w"></span>
<span class="linenos"> 5</span><span class="kd">const</span><span class="w"> </span><span class="nx">uploadAvatarMiddleware</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">multiparty</span><span class="p">({</span><span class="nx">uploadDir</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;./uploads/avatars&#39;</span><span class="p">});</span><span class="w"></span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="kd">const</span><span class="w"> </span><span class="nx">api</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span><span class="w"></span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="nx">api</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/register&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">userController</span><span class="p">.</span><span class="nx">postUser</span><span class="p">);</span><span class="w"></span>
<span class="linenos">10</span><span class="nx">api</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/login&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">userController</span><span class="p">.</span><span class="nx">login</span><span class="p">);</span><span class="w"></span>
<span class="linenos">11</span><span class="nx">api</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/forgot&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">userController</span><span class="p">.</span><span class="nx">forgot</span><span class="p">);</span><span class="w"></span>
<span class="linenos">12</span><span class="nx">api</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s2">&quot;/reset/:id/:token&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">userController</span><span class="p">.</span><span class="nx">resetPassword</span><span class="p">);</span><span class="w"></span>
<span class="linenos">13</span><span class="nx">api</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/users&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">authMiddleware</span><span class="p">.</span><span class="nx">secureRoute</span><span class="p">],</span><span class="w"> </span><span class="nx">userController</span><span class="p">.</span><span class="nx">getUser</span><span class="p">);</span><span class="w"></span>
<span class="linenos">14</span><span class="nx">api</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s2">&quot;/users/:id&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">authMiddleware</span><span class="p">.</span><span class="nx">secureRoute</span><span class="p">,</span><span class="w"> </span><span class="nx">uploadAvatarMiddleware</span><span class="p">],</span><span class="w"> </span><span class="nx">userController</span><span class="p">.</span><span class="nx">putUser</span><span class="p">);</span><span class="w"></span>
<span class="linenos">15</span><span class="nx">api</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/users/avatar/:avatarName&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">userController</span><span class="p">.</span><span class="nx">getAvatar</span><span class="p">);</span><span class="w"></span>
<span class="linenos">16</span><span class="c1">// ruta para eliminar usuarios:</span><span class="w"></span>
<span class="linenos">17</span><span class="nx">api</span><span class="p">.</span><span class="ow">delete</span><span class="p">(</span><span class="s2">&quot;/users/:id&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">authMiddleware</span><span class="p">.</span><span class="nx">secureRoute</span><span class="p">],</span><span class="w"> </span><span class="nx">userController</span><span class="p">.</span><span class="nx">deleteUser</span><span class="p">);</span><span class="w"></span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">api</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>Ahora se puede crear el endpoint en Postman para eliminar usuarios.</p></li>
</ul>
</section>
<section id="paso-9-subir-cambios-a-github">
<h3><a class="toc-backref" href="#id62">Paso 9: Subir cambios a GitHub</a><a class="headerlink" href="#paso-9-subir-cambios-a-github" title="Enlazar permanentemente con este título">¶</a></h3>
<ul class="simple">
<li><p>Parar depuración de Visual studio code.</p></li>
<li><p>Añadir cambios: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">add</span> <span class="pre">.</span></code></p></li>
<li><p>Realizar un commit: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">commit</span> <span class="pre">-am</span> <span class="pre">&quot;Phase</span> <span class="pre">4</span> <span class="pre">complete&quot;</span></code></p></li>
<li><p>Subir cambios a Github con el nombre de la rama actual: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">push</span> <span class="pre">origin</span> <span class="pre">feature/upload-data-service</span></code></p></li>
<li><p>Desde gitHub presionar botón <strong>Compare &amp; pull request</strong>.</p></li>
<li><p>cambiar rama base <strong>master</strong> por <strong>developer</strong> y pulsar <strong>Create pull request</strong></p></li>
<li><p>Pulsar en <strong>Merge pull request</strong> y a continuación en <strong>Confirm merge</strong>.</p></li>
<li><p>Una vez terminado volvemos a local y cambiamos de rama a developer: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">checkout</span> <span class="pre">developer</span></code></p></li>
<li><p>Actualizamos rama developer: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">pull</span> <span class="pre">origin</span> <span class="pre">developer</span></code></p></li>
</ul>
<p>Y con esto concluye la cuarta fase del proyecto.</p>
<hr><br></section>
</section>
</section>


          </div>
          <div class="page-nav">
            <div class="inner"><ul class="page-nav">
  <li class="prev">
    <a href="../index.html"
       title="capítulo anterior">← Recetas Fullcoder - Agile Learning Practico</a>
  </li>
  <li class="next">
    <a href="../frontend/react.html"
       title="próximo capítulo">Frontend React Task Learn →</a>
  </li>
</ul><div class="footer" role="contentinfo">
      &#169; Derechos de autor Creado por Guillermo Granados Gomez bajo Licencia MIT.
</div>
            </div>
          </div>
      </page>
    </div></div>
    
    
  </body>
</html>